<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©æœºé˜ | DivineChat Pro</title>
    <!-- åŸºç¡€ä¾èµ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro@2.0.5/dist/iztro.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind é…ç½®ï¼šç»Ÿä¸€å­—ä½“æ ‡å‡† -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // ç»Ÿä¸€ä½¿ç”¨é€‚ç”¨æ€§æœ€å¹¿çš„é»‘ä½“æ ‡å‡†ï¼Œä¼˜å…ˆè°ƒç”¨æœ¬åœ°é«˜æ€§èƒ½å­—ä½“
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"PingFang SC"', '"Hiragino Sans GB"', '"Microsoft YaHei"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        serif: ['"Noto Serif SC"', '"Songti SC"', '"SimSun"', 'serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace']
                    },
                    colors: {
                        stone: { 50:'#fafaf9', 100:'#f5f5f4', 200:'#e7e5e4', 300:'#d6d3d1', 400:'#a8a29e', 500:'#78716c', 800:'#292524', 900:'#1c1917' },
                        gold: { DEFAULT: '#b49b7e' }
                    },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)', 'float': '0 10px 40px -10px rgba(0, 0, 0, 0.08)' }
                }
            }
        }
    </script>
    
    <style>
        /* å…¨å±€æ ·å¼ä¸PCèƒŒæ™¯ä¼˜åŒ– */
        body { background-color: #f0f0f0; color: #1c1917; -webkit-font-smoothing: antialiased; }
        
        /* PCç«¯ç‚¹é˜µèƒŒæ™¯çº¹ç† */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#d1d5db 1px, transparent 1px); 
            background-size: 24px 24px; opacity: 0.5; z-index: -1;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* åŠ¨ç”»ä¸è¿‡æ¸¡ */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* è¾“å…¥æ¡†ä¸‹åˆ’çº¿åŠ¨ç”» */
        .input-underline { position: relative; }
        .input-underline::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background-color: #1c1917; transition: width 0.3s ease; }
        .input-wrapper:focus-within .input-underline::after { width: 100%; }
        
        /* æ‰“å­—æœºå…‰æ ‡ */
        .typing-dot { width: 4px; height: 4px; background-color: #a8a29e; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Prose Markdown æ ·å¼ä¼˜åŒ– */
        .prose p { margin-bottom: 0.8rem; line-height: 1.7; font-size: 0.95rem; color: #44403c; text-align: justify; }
        .prose > :last-child { margin-bottom: 0; }
        .prose h1, .prose h2, .prose h3 { font-family: "Songti SC", "SimSun", serif; color: #1c1917; margin-top: 1.2rem; margin-bottom: 0.6rem; font-weight: 700; border-bottom: 1px dashed #d6d3d1; padding-bottom: 0.2rem; }
        
        /* é‡ç‚¹é«˜äº® - æŸ”çº¢åº•è‰² */
        .prose strong { color: #991b1b; font-weight: 600; background-color: #fef2f2; padding: 0.1em 0.3em; border-radius: 0.2em; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
        
        /* å¼•ç”¨å— - ä¾§è¾¹å¡ç‰‡ */
        .prose blockquote { border-left: 3px solid #d6d3d1; background: #fafaf9; padding: 0.5rem 1rem; margin: 1rem 0; font-size: 0.9rem; color: #57534e; border-radius: 0 8px 8px 0; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 1rem; }
    </style>
</head>

<!-- Body: PCç«¯å±…ä¸­å¸ƒå±€ -->
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center">

    <!-- App Container: PCç«¯é™åˆ¶æœ€å¤§å®½åº¦+åœ†è§’+é˜´å½± -->
    <div id="app" class="w-full h-full md:max-w-4xl md:h-[90vh] md:rounded-3xl flex flex-col relative bg-stone-50 shadow-2xl shadow-stone-300/50 md:border md:border-white/50 overflow-hidden transition-all duration-300">

        <!-- Header -->
        <header class="w-full px-6 py-4 flex justify-between items-center bg-stone-50/90 backdrop-blur-md z-30 sticky top-0 border-b border-stone-200/50">
            <div class="flex items-center gap-3 group cursor-pointer" @click="returnToHome">
                <div class="w-9 h-9 rounded-lg bg-stone-900 flex items-center justify-center text-stone-50 shadow-lg transition-transform group-hover:scale-95">
                    <span class="font-serif text-xl">å¤©</span>
                </div>
                <div class="flex flex-col">
                    <h1 class="text-base font-bold tracking-wide text-stone-900 font-serif">å¤©æœºé˜</h1>
                    <span class="text-[0.6rem] text-stone-500 uppercase tracking-widest font-sans">DivineChat Pro v2.1</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button @click="showHistory = true" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-stone-200 transition-colors text-stone-500 hover:text-stone-900" title="å†å²è®°å½•">
                    <i class="fa-solid fa-clock-rotate-left text-sm"></i>
                </button>
                <button @click="showSettings = true" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-stone-200 transition-colors text-stone-500 hover:text-stone-900" title="è®¾ç½®">
                    <i class="fa-solid fa-sliders text-sm"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 w-full relative overflow-hidden flex flex-col">
            
            <!-- 1. è¾“å…¥ç•Œé¢ (è¡¨å•) -->
            <transition name="fade">
                <div v-if="!chartGenerated" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-6 bg-stone-50 overflow-y-auto">
                    <div class="w-full max-w-sm space-y-8 animate-fade-in-up">
                        <div class="text-center space-y-2">
                            <h2 class="text-2xl font-serif font-bold text-stone-800">å¼€å¯å‘½ç†æ¨æ¼”</h2>
                            <p class="text-xs text-stone-500 tracking-wide">çœŸå¤ªé˜³æ—¶æ ¡æ­£ Â· ç´«å¾®æ–—æ•° Â· å­å¹³å…«å­—</p>
                        </div>
                        <div class="space-y-6 bg-white p-6 rounded-2xl shadow-soft border border-stone-100">
                            <!-- å§“å -->
                            <div class="input-wrapper group">
                                <label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-wider">å§“å</label>
                                <div class="input-underline"><input v-model="userInput.name" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„ç§°å‘¼" class="w-full bg-transparent py-2 text-lg text-stone-800 placeholder-stone-300 focus:outline-none transition-colors"></div>
                            </div>
                            
                            <!-- åœ°åŒºé€‰æ‹© -->
                            <div class="grid grid-cols-2 gap-6">
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-wider">å‡ºç”Ÿçœä»½</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.province" @change="handleProvinceChange" class="w-full bg-transparent py-2 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer">
                                            <option v-for="(cities, prov) in chinaAreaData" :key="prov" :value="prov">{{ prov }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-3 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-wider">åŸå¸‚/åœ°åŒº</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.city" class="w-full bg-transparent py-2 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer" :disabled="!userInput.province">
                                            <option v-for="city in availableCities" :key="city.name" :value="city">{{ city.name }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-3 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- æ—¶é—´é€‰æ‹© -->
                            <div class="grid grid-cols-2 gap-6">
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-wider">å…¬å†æ—¥æœŸ</label>
                                    <div class="input-underline"><input v-model="userInput.date" type="date" class="w-full bg-transparent py-2 text-base text-stone-800 focus:outline-none font-sans"></div>
                                </div>
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-bold text-stone-400 mb-1 uppercase tracking-wider">å‡ºç”Ÿæ—¶è¾°</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.time" class="w-full bg-transparent py-2 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer font-serif">
                                            <option v-for="t in shichenOptions" :key="t.val" :value="t.val">
                                                {{ t.name }} ({{ t.range }})
                                            </option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-3 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ€§åˆ« -->
                            <div class="input-wrapper group">
                                <label class="block text-xs font-bold text-stone-400 mb-2 uppercase tracking-wider">æ€§åˆ«</label>
                                <div class="flex gap-4 py-1">
                                    <button @click="userInput.gender = 'male'" :class="['text-sm transition-colors', userInput.gender === 'male' ? 'text-stone-900 font-bold' : 'text-stone-300 hover:text-stone-500']">ç”· (ä¹¾é€ )</button>
                                    <span class="text-stone-200">/</span>
                                    <button @click="userInput.gender = 'female'" :class="['text-sm transition-colors', userInput.gender === 'female' ? 'text-stone-900 font-bold' : 'text-stone-300 hover:text-stone-500']">å¥³ (å¤é€ )</button>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button @click="generateChart" class="w-full bg-stone-900 text-stone-50 py-3.5 rounded-xl text-sm font-bold hover:bg-stone-800 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-3">
                                    <span>å¼€å§‹æ¨æ¼”</span><i class="fa-solid fa-arrow-right text-xs opacity-50"></i>
                                </button>
                                <div class="mt-4 flex justify-center items-center gap-2 text-[0.6rem] text-stone-400"><i class="fa-solid fa-lock text-stone-300"></i><span>æœ¬åœ°è®¡ç®— Â· éšç§åŠ å¯†</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- 2. èŠå¤©ç•Œé¢ -->
            <transition name="fade">
                <div v-if="chartGenerated" class="flex-1 flex flex-col h-full bg-stone-50">
                    <!-- é¡¶éƒ¨ä¿¡æ¯æ¡ -->
                    <div class="px-6 py-3 bg-stone-50/90 backdrop-blur border-b border-stone-100 flex justify-between items-center z-10 shadow-sm">
                        <div class="flex items-center gap-4 text-xs">
                            <div class="flex flex-col"><span class="text-stone-400 text-[10px] scale-90 origin-left">å…«å­—</span><span class="font-mono text-stone-800 font-bold">{{ chartData.baziString }}</span></div>
                            <div class="w-px h-6 bg-stone-200"></div>
                            <div class="flex flex-col"><span class="text-stone-400 text-[10px] scale-90 origin-left">çœŸå¤ªé˜³æ—¶</span><span class="font-mono text-stone-800">{{ chartData.trueSolarTime.split(' ')[1] }}</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-[0.65rem] text-gold font-bold bg-gold/10 px-2 py-1 rounded-md">
                            <i class="fa-solid fa-location-arrow"></i><span>{{ userInput.city.name }}</span>
                        </div>
                    </div>

                    <!-- è§’è‰²åˆ‡æ¢æ¡ -->
                    <div class="px-6 pt-4 pb-2 bg-stone-50 z-10">
                        <div class="flex p-1 bg-stone-200/50 rounded-lg overflow-x-auto no-scrollbar">
                            <button v-for="role in personas" :key="role.id" @click="switchPersona(role.id)"
                                :class="['flex-1 py-1.5 px-3 rounded-md text-xs font-bold transition-all duration-300 whitespace-nowrap', currentPersonaId === role.id ? 'bg-white text-stone-900 shadow-sm scale-100' : 'text-stone-400 hover:text-stone-600 scale-95']">
                                {{ role.name }}
                            </button>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                    <div ref="chatRef" class="flex-1 overflow-y-auto px-4 md:px-8 py-6 space-y-6 no-scrollbar scroll-smooth">
                        
                        <!-- å‘½ç›˜æ¦‚è¦å¡ç‰‡ -->
                        <div v-if="chatHistory.length === 0" class="w-full bg-white rounded-2xl p-6 shadow-soft border border-stone-100 animate-fade-in-up">
                            <div class="flex items-center gap-3 mb-4"><div class="w-1 h-4 bg-stone-900 rounded-full"></div><h3 class="text-sm font-serif font-bold text-stone-900">å‘½ç›˜æ¦‚è¦</h3></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-xs leading-relaxed text-stone-600">
                                <div><p class="text-stone-400 mb-1 uppercase tracking-wider text-[0.6rem]">ç´«å¾®å‘½å®«</p><p class="font-serif text-stone-800 font-bold">{{ chartData.ziweiSummary }}</p></div>
                                <div><p class="text-stone-400 mb-1 uppercase tracking-wider text-[0.6rem]">äº”è¡Œèƒ½é‡</p><p class="font-serif text-stone-800 font-bold">{{ chartData.wuxingDetail }}</p></div>
                            </div>
                        </div>

                        <!-- æ¶ˆæ¯å¾ªç¯ -->
                        <div v-for="(msg, index) in chatHistory" :key="index" class="w-full animate-fade-in-up">
                            
                            <!-- ç±»å‹1ï¼šç³»ç»Ÿäº‹ä»¶ (æ‹ä¸€æ‹æ•ˆæœ) -->
                            <div v-if="msg.role === 'event'" class="flex justify-center my-4">
                                <span class="bg-stone-200/70 text-stone-500 text-[0.65rem] px-3 py-1 rounded-full shadow-sm backdrop-blur-sm">
                                    {{ msg.content }}
                                </span>
                            </div>

                            <!-- ç±»å‹2ï¼šå¯¹è¯æ¶ˆæ¯ -->
                            <div v-else>
                                <!-- æ¶ˆæ¯æ—¶é—´æˆ³ (å±…ä¸­æ˜¾ç¤º) -->
                                <div class="flex justify-center mb-2">
                                    <span class="text-[0.6rem] text-stone-300 font-mono select-none">{{ formatMsgTime(msg.timestamp) }}</span>
                                </div>

                                <!-- ç”¨æˆ·æ¶ˆæ¯ -->
                                <div v-if="msg.role === 'user'" class="flex justify-end">
                                    <div class="max-w-[85%] bg-stone-900 text-stone-50 px-5 py-3 rounded-2xl rounded-tr-xs shadow-md text-sm leading-relaxed tracking-wide">
                                        {{ msg.content }}
                                    </div>
                                </div>
                                
                                <!-- å¤§å¸ˆæ¶ˆæ¯ -->
                                <div v-else class="flex gap-3 md:gap-4">
                                    <div class="flex-shrink-0 flex flex-col items-center gap-2">
                                        <div class="w-9 h-9 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-700 shadow-sm">
                                            <i :class="['fa-solid text-sm', msg.icon || currentPersona.icon]"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-baseline gap-2 mb-1">
                                            <span class="text-xs font-bold text-stone-900">{{ msg.name || currentPersona.name }}</span>
                                            <span class="text-[0.6rem] text-stone-400">{{ msg.desc || currentPersona.desc }}</span>
                                        </div>
                                        <div class="bg-white border border-stone-200/60 px-5 py-4 rounded-2xl rounded-tl-xs shadow-sm text-sm text-stone-700 leading-7 prose prose-sm max-w-none">
                                            <div v-html="renderMarkdown(msg.content)"></div>
                                            <div v-if="msg.isTyping" class="flex gap-1 py-1"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="h-12"></div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="absolute bottom-6 left-0 right-0 px-4 md:px-8 z-20">
                        <div class="max-w-3xl mx-auto bg-white/90 backdrop-blur-xl rounded-2xl shadow-float border border-stone-200 p-2 flex items-center gap-2 transition-all focus-within:ring-2 focus-within:ring-stone-200">
                            <input v-model="userMessage" @keyup.enter="handleSend" type="text" :placeholder="isLoading ? 'é˜ä¸»æ­£åœ¨è®°å½•...' : `å‘${currentPersona.name}æé—® (æ”¯æŒè¯¢é—®'ä»Šå¹´'ã€'ç°åœ¨')...`" :disabled="isLoading" class="flex-1 bg-transparent px-4 py-3 text-sm text-stone-800 placeholder-stone-400 focus:outline-none">
                            <button @click="handleSend" :disabled="isLoading || !userMessage.trim()" class="w-10 h-10 rounded-xl bg-stone-900 text-stone-50 flex items-center justify-center hover:bg-stone-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md">
                                <i v-if="!isLoading" class="fa-solid fa-paper-plane text-xs"></i>
                                <i v-else class="fa-solid fa-spinner fa-spin text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

        </main>

        <!-- è®¾ç½®å¼¹çª— -->
        <div v-if="showSettings" class="absolute inset-0 z-50 bg-stone-900/20 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl border border-stone-100 transform transition-all animate-fade-in-up">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-lg font-serif font-bold text-stone-900">ç³»ç»Ÿè®¾ç½®</h3>
                    <button @click="showSettings = false" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:text-stone-900 flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button>
                </div>
                <div class="space-y-6">
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">API Endpoint</label><input v-model="settings.baseUrl" placeholder="e.g. https://api.openai.com/v1" class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">API Key</label><input v-model="settings.apiKey" type="password" placeholder="sk-..." class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">Model Name</label><input v-model="settings.model" placeholder="gpt-4o" class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div v-if="verifyStatus" :class="['text-xs px-4 py-3 rounded-lg flex items-center gap-2', verifyStatus.ok ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700']"><i :class="['fa-solid', verifyStatus.ok ? 'fa-check' : 'fa-exclamation-circle']"></i>{{ verifyStatus.msg }}</div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button @click="runTest" :disabled="isVerifying" class="flex-1 py-3 border border-stone-200 rounded-xl text-xs font-bold text-stone-600 hover:bg-stone-50 transition-colors">{{ isVerifying ? 'è¿æ¥ä¸­...' : 'æµ‹è¯•è¿æ¥' }}</button>
                    <button @click="saveSettings" class="flex-1 py-3 bg-stone-900 text-stone-50 rounded-xl text-xs font-bold hover:bg-stone-800 transition-colors">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•å¼¹çª— -->
        <div v-if="showHistory" class="absolute inset-0 z-50 bg-stone-900/20 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl border border-stone-100 transform transition-all animate-fade-in-up flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-serif font-bold text-stone-900">æ¨æ¼”è®°å½•</h3>
                    <button @click="showHistory = false" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:text-stone-900 flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-3 pr-1 -mr-2 scroll-smooth">
                    <div v-if="sessions.length === 0" class="text-center py-8 text-stone-400 text-xs">æš‚æ— å†å²è®°å½•</div>
                    <div v-for="session in sortedSessions" :key="session.id" 
                        class="group relative bg-stone-50 hover:bg-stone-100 rounded-xl p-4 border border-stone-100 transition-all cursor-pointer"
                        @click="loadSession(session.id)">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold text-stone-800">{{ session.name || 'æœ‰ç¼˜äºº' }}</span>
                            <span class="text-[0.6rem] text-stone-400">{{ formatDate(session.timestamp) }}</span>
                        </div>
                        <div class="text-[0.65rem] text-stone-500 line-clamp-2">
                            {{ session.summary }}
                        </div>
                        <button @click.stop="deleteSession(session.id)" class="absolute top-2 right-2 p-2 text-stone-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
const { createApp, ref, computed, nextTick, reactive, watch, onMounted } = Vue;

class LLMService {
    constructor(config) { this.config = config; this.abortController = null; }
    _buildUrl(path) {
        let base = this.config.baseUrl.trim().replace(/\/+$/, '');
        if (!base.includes('/v1') && !base.includes('/chat/completions')) base += '/v1';
        return `${base}${path}`;
    }
    async chatStream(messages, onChunk, onError, onFinish) {
        this.abortController = new AbortController();
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: messages, stream: true, temperature: 0.7 }),
                signal: this.abortController.signal
            });
            if (!res.ok) {
                let errDetails = res.statusText;
                try { const j = await res.json(); if(j.error?.message) errDetails = j.error.message; } catch(e){}
                throw new Error(`API ${res.status}: ${errDetails}`);
            }
            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed === 'data: [DONE]') continue;
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(trimmed.slice(6));
                            const content = json.choices[0]?.delta?.content || '';
                            if (content) onChunk(content);
                        } catch (e) {}
                    }
                }
            }
            if (onFinish) onFinish();
        } catch (error) {
            if (error.name === 'AbortError') return;
            onError(error.message);
        }
    }
    async testConnection() {
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: [{ role: "user", content: "Hi" }], max_tokens: 1 })
            });
            return res.ok ? { ok: true, msg: "è¿æ¥æˆåŠŸ" } : { ok: false, msg: `é”™è¯¯ ${res.status}` };
        } catch (e) { return { ok: false, msg: "ç½‘ç»œé”™è¯¯" }; }
    }
}

// -----------------------------------------------------------
// 2. æ ¸å¿ƒæ•°æ® & æ— æ•Œæç¤ºè¯ç³»ç»Ÿ
// -----------------------------------------------------------

// å®Œæ•´åŸå¸‚æ•°æ® (æ¢å¤åŸç‰ˆæ•°æ®)
const CHINA_AREA_DATA = {
    "åŒ—äº¬å¸‚": [{name:"åŒ—äº¬å¸‚", lon:116.40}],
    "å¤©æ´¥å¸‚": [{name:"å¤©æ´¥å¸‚", lon:117.20}],
    "ä¸Šæµ·å¸‚": [{name:"ä¸Šæµ·å¸‚", lon:121.47}],
    "é‡åº†å¸‚": [{name:"é‡åº†å¸‚", lon:106.55}],
    "æ²³åŒ—çœ": [{name:"çŸ³å®¶åº„å¸‚", lon:114.48}, {name:"å”å±±å¸‚", lon:118.02}, {name:"ç§¦çš‡å²›å¸‚", lon:119.57}, {name:"é‚¯éƒ¸å¸‚", lon:114.47}, {name:"é‚¢å°å¸‚", lon:114.48}, {name:"ä¿å®šå¸‚", lon:115.48}, {name:"å¼ å®¶å£å¸‚", lon:114.87}, {name:"æ‰¿å¾·å¸‚", lon:117.93}, {name:"æ²§å·å¸‚", lon:116.83}, {name:"å»ŠåŠå¸‚", lon:116.70}, {name:"è¡¡æ°´å¸‚", lon:115.72}],
    "å±±è¥¿çœ": [{name:"å¤ªåŸå¸‚", lon:112.53}, {name:"å¤§åŒå¸‚", lon:113.30}, {name:"é˜³æ³‰å¸‚", lon:113.57}, {name:"é•¿æ²»å¸‚", lon:113.08}, {name:"æ™‹åŸå¸‚", lon:112.83}, {name:"æœ”å·å¸‚", lon:112.43}, {name:"æ™‹ä¸­å¸‚", lon:112.75}, {name:"è¿åŸå¸‚", lon:111.00}, {name:"å¿»å·å¸‚", lon:112.73}, {name:"ä¸´æ±¾å¸‚", lon:111.52}, {name:"å•æ¢å¸‚", lon:111.13}],
    "è¾½å®çœ": [{name:"æ²ˆé˜³å¸‚", lon:123.38}, {name:"å¤§è¿å¸‚", lon:121.62}, {name:"éå±±å¸‚", lon:122.99}, {name:"æŠšé¡ºå¸‚", lon:123.97}, {name:"æœ¬æºªå¸‚", lon:123.73}, {name:"ä¸¹ä¸œå¸‚", lon:124.37}, {name:"é”¦å·å¸‚", lon:121.15}, {name:"è¥å£å¸‚", lon:122.18}, {name:"é˜œæ–°å¸‚", lon:121.65}, {name:"è¾½é˜³å¸‚", lon:123.17}, {name:"ç›˜é”¦å¸‚", lon:122.07}, {name:"é“å²­å¸‚", lon:123.85}, {name:"æœé˜³å¸‚", lon:120.42}, {name:"è‘«èŠ¦å²›å¸‚", lon:120.83}],
    "å‰æ—çœ": [{name:"é•¿æ˜¥å¸‚", lon:125.35}, {name:"å‰æ—å¸‚", lon:126.57}, {name:"å››å¹³å¸‚", lon:124.37}, {name:"è¾½æºå¸‚", lon:125.15}, {name:"é€šåŒ–å¸‚", lon:125.92}, {name:"ç™½å±±å¸‚", lon:126.40}, {name:"æ¾åŸå¸‚", lon:124.82}, {name:"ç™½åŸå¸‚", lon:122.82}, {name:"å»¶è¾¹", lon:129.52}],
    "é»‘é¾™æ±Ÿçœ": [{name:"å“ˆå°”æ»¨å¸‚", lon:126.63}, {name:"é½é½å“ˆå°”å¸‚", lon:123.97}, {name:"é¸¡è¥¿å¸‚", lon:130.97}, {name:"é¹¤å²—å¸‚", lon:130.28}, {name:"åŒé¸­å±±å¸‚", lon:131.17}, {name:"å¤§åº†å¸‚", lon:125.03}, {name:"ä¼Šæ˜¥å¸‚", lon:128.92}, {name:"ä½³æœ¨æ–¯å¸‚", lon:130.35}, {name:"ä¸ƒå°æ²³å¸‚", lon:131.02}, {name:"ç‰¡ä¸¹æ±Ÿå¸‚", lon:129.62}, {name:"é»‘æ²³å¸‚", lon:127.53}, {name:"ç»¥åŒ–å¸‚", lon:126.98}, {name:"å¤§å…´å®‰å²­", lon:124.72}, {name:"æ¼ æ²³", lon:122.37}],
    "æ±Ÿè‹çœ": [{name:"å—äº¬å¸‚", lon:118.78}, {name:"æ— é”¡å¸‚", lon:120.29}, {name:"å¾å·å¸‚", lon:117.18}, {name:"å¸¸å·å¸‚", lon:119.95}, {name:"è‹å·å¸‚", lon:120.62}, {name:"å—é€šå¸‚", lon:120.86}, {name:"è¿äº‘æ¸¯å¸‚", lon:119.16}, {name:"æ·®å®‰å¸‚", lon:119.02}, {name:"ç›åŸå¸‚", lon:120.13}, {name:"æ‰¬å·å¸‚", lon:119.42}, {name:"é•‡æ±Ÿå¸‚", lon:119.44}, {name:"æ³°å·å¸‚", lon:119.90}, {name:"å®¿è¿å¸‚", lon:118.28}],
    "æµ™æ±Ÿçœ": [{name:"æ­å·å¸‚", lon:120.15}, {name:"å®æ³¢å¸‚", lon:121.56}, {name:"æ¸©å·å¸‚", lon:120.65}, {name:"å˜‰å…´å¸‚", lon:120.76}, {name:"æ¹–å·å¸‚", lon:120.10}, {name:"ç»å…´å¸‚", lon:120.58}, {name:"é‡‘åå¸‚", lon:119.64}, {name:"è¡¢å·å¸‚", lon:118.88}, {name:"èˆŸå±±å¸‚", lon:122.20}, {name:"å°å·å¸‚", lon:121.42}, {name:"ä¸½æ°´å¸‚", lon:119.92}],
    "å®‰å¾½çœ": [{name:"åˆè‚¥å¸‚", lon:117.27}, {name:"èŠœæ¹–å¸‚", lon:118.38}, {name:"èšŒåŸ å¸‚", lon:117.34}, {name:"æ·®å—å¸‚", lon:116.98}, {name:"é©¬éå±±å¸‚", lon:118.50}, {name:"æ·®åŒ—å¸‚", lon:116.80}, {name:"é“œé™µå¸‚", lon:117.82}, {name:"å®‰åº†å¸‚", lon:117.05}, {name:"é»„å±±å¸‚", lon:118.32}, {name:"æ»å·å¸‚", lon:118.31}, {name:"é˜œé˜³å¸‚", lon:115.82}, {name:"å®¿å·å¸‚", lon:116.97}, {name:"å…­å®‰å¸‚", lon:116.50}, {name:"äº³å·å¸‚", lon:115.78}, {name:"æ± å·å¸‚", lon:117.48}, {name:"å®£åŸå¸‚", lon:118.75}],
    "ç¦å»ºçœ": [{name:"ç¦å·å¸‚", lon:119.30}, {name:"å¦é—¨å¸‚", lon:118.10}, {name:"è†ç”°å¸‚", lon:119.00}, {name:"ä¸‰æ˜å¸‚", lon:117.63}, {name:"æ³‰å·å¸‚", lon:118.58}, {name:"æ¼³å·å¸‚", lon:117.66}, {name:"å—å¹³å¸‚", lon:118.17}, {name:"é¾™å²©å¸‚", lon:117.03}, {name:"å®å¾·å¸‚", lon:119.52}],
    "æ±Ÿè¥¿çœ": [{name:"å—æ˜Œå¸‚", lon:115.89}, {name:"æ™¯å¾·é•‡å¸‚", lon:117.22}, {name:"èä¹¡å¸‚", lon:113.85}, {name:"ä¹æ±Ÿå¸‚", lon:115.97}, {name:"æ–°ä½™å¸‚", lon:114.92}, {name:"é¹°æ½­å¸‚", lon:117.03}, {name:"èµ£å·å¸‚", lon:114.94}, {name:"å‰å®‰å¸‚", lon:114.97}, {name:"å®œæ˜¥å¸‚", lon:114.38}, {name:"æŠšå·å¸‚", lon:116.35}, {name:"ä¸Šé¥¶å¸‚", lon:117.98}],
    "å±±ä¸œçœ": [{name:"æµå—å¸‚", lon:117.00}, {name:"é’å²›å¸‚", lon:120.33}, {name:"æ·„åšå¸‚", lon:118.05}, {name:"æ£åº„å¸‚", lon:117.57}, {name:"ä¸œè¥å¸‚", lon:118.49}, {name:"çƒŸå°å¸‚", lon:121.39}, {name:"æ½åŠå¸‚", lon:119.10}, {name:"æµå®å¸‚", lon:116.59}, {name:"æ³°å®‰å¸‚", lon:117.13}, {name:"å¨æµ·å¸‚", lon:122.10}, {name:"æ—¥ç…§å¸‚", lon:119.46}, {name:"ä¸´æ²‚å¸‚", lon:118.35}, {name:"å¾·å·å¸‚", lon:116.39}, {name:"èŠåŸå¸‚", lon:115.97}, {name:"æ»¨å·å¸‚", lon:118.03}, {name:"èæ³½å¸‚", lon:115.48}],
    "æ²³å—çœ": [{name:"éƒ‘å·å¸‚", lon:113.65}, {name:"å¼€å°å¸‚", lon:114.35}, {name:"æ´›é˜³å¸‚", lon:112.42}, {name:"å¹³é¡¶å±±å¸‚", lon:113.29}, {name:"å®‰é˜³å¸‚", lon:114.35}, {name:"é¹¤å£å¸‚", lon:114.28}, {name:"æ–°ä¹¡å¸‚", lon:113.85}, {name:"ç„¦ä½œå¸‚", lon:113.23}, {name:"æ¿®é˜³å¸‚", lon:115.03}, {name:"è®¸æ˜Œå¸‚", lon:113.81}, {name:"æ¼¯æ²³å¸‚", lon:114.02}, {name:"ä¸‰é—¨å³¡å¸‚", lon:111.19}, {name:"å—é˜³å¸‚", lon:112.53}, {name:"å•†ä¸˜å¸‚", lon:115.65}, {name:"ä¿¡é˜³å¸‚", lon:114.07}, {name:"å‘¨å£å¸‚", lon:114.63}, {name:"é©»é©¬åº—å¸‚", lon:114.03}],
    "æ¹–åŒ—çœ": [{name:"æ­¦æ±‰å¸‚", lon:114.30}, {name:"é»„çŸ³å¸‚", lon:115.08}, {name:"åå °å¸‚", lon:110.78}, {name:"å®œæ˜Œå¸‚", lon:111.27}, {name:"è¥„é˜³å¸‚", lon:112.14}, {name:"é„‚å·å¸‚", lon:114.88}, {name:"è†é—¨å¸‚", lon:112.20}, {name:"å­æ„Ÿå¸‚", lon:113.92}, {name:"è†å·å¸‚", lon:112.23}, {name:"é»„å†ˆå¸‚", lon:114.87}, {name:"å’¸å®å¸‚", lon:114.32}, {name:"éšå·å¸‚", lon:113.37}, {name:"æ©æ–½", lon:109.48}],
    "æ¹–å—çœ": [{name:"é•¿æ²™å¸‚", lon:112.98}, {name:"æ ªæ´²å¸‚", lon:113.15}, {name:"æ¹˜æ½­å¸‚", lon:112.91}, {name:"è¡¡é˜³å¸‚", lon:112.61}, {name:"é‚µé˜³å¸‚", lon:111.45}, {name:"å²³é˜³å¸‚", lon:113.13}, {name:"å¸¸å¾·å¸‚", lon:111.69}, {name:"å¼ å®¶ç•Œå¸‚", lon:110.48}, {name:"ç›Šé˜³å¸‚", lon:112.33}, {name:"éƒ´å·å¸‚", lon:113.03}, {name:"æ°¸å·å¸‚", lon:111.60}, {name:"æ€€åŒ–å¸‚", lon:110.00}, {name:"å¨„åº•å¸‚", lon:112.00}, {name:"æ¹˜è¥¿", lon:109.73}],
    "å¹¿ä¸œçœ": [{name:"å¹¿å·å¸‚", lon:113.26}, {name:"éŸ¶å…³å¸‚", lon:113.60}, {name:"æ·±åœ³å¸‚", lon:114.05}, {name:"ç æµ·å¸‚", lon:113.52}, {name:"æ±•å¤´å¸‚", lon:116.70}, {name:"ä½›å±±å¸‚", lon:113.11}, {name:"æ±Ÿé—¨å¸‚", lon:113.06}, {name:"æ¹›æ±Ÿå¸‚", lon:110.40}, {name:"èŒ‚åå¸‚", lon:110.88}, {name:"è‚‡åº†å¸‚", lon:112.44}, {name:"æƒ å·å¸‚", lon:114.40}, {name:"æ¢…å·å¸‚", lon:116.10}, {name:"æ±•å°¾å¸‚", lon:115.37}, {name:"æ²³æºå¸‚", lon:114.68}, {name:"é˜³æ±Ÿå¸‚", lon:111.95}, {name:"æ¸…è¿œå¸‚", lon:113.01}, {name:"ä¸œèå¸‚", lon:113.75}, {name:"ä¸­å±±å¸‚", lon:113.38}, {name:"æ½®å·å¸‚", lon:116.63}, {name:"æ­é˜³å¸‚", lon:116.35}, {name:"äº‘æµ®å¸‚", lon:112.02}],
    "å¹¿è¥¿": [{name:"å—å®å¸‚", lon:108.33}, {name:"æŸ³å·å¸‚", lon:109.40}, {name:"æ¡‚æ—å¸‚", lon:110.28}, {name:"æ¢§å·å¸‚", lon:111.34}, {name:"åŒ—æµ·å¸‚", lon:109.12}, {name:"é˜²åŸæ¸¯å¸‚", lon:108.35}, {name:"é’¦å·å¸‚", lon:108.62}, {name:"è´µæ¸¯å¸‚", lon:109.60}, {name:"ç‰æ—å¸‚", lon:110.14}, {name:"ç™¾è‰²å¸‚", lon:106.62}, {name:"è´ºå·å¸‚", lon:111.55}, {name:"æ²³æ± å¸‚", lon:107.86}, {name:"æ¥å®¾å¸‚", lon:109.24}, {name:"å´‡å·¦å¸‚", lon:107.37}],
    "æµ·å—çœ": [{name:"æµ·å£å¸‚", lon:110.35}, {name:"ä¸‰äºšå¸‚", lon:109.51}, {name:"ä¸‰æ²™å¸‚", lon:112.34}, {name:"å„‹å·å¸‚", lon:109.57}],
    "å››å·çœ": [{name:"æˆéƒ½å¸‚", lon:104.06}, {name:"è‡ªè´¡å¸‚", lon:104.78}, {name:"æ”€æèŠ±å¸‚", lon:101.71}, {name:"æ³¸å·å¸‚", lon:105.39}, {name:"å¾·é˜³å¸‚", lon:104.37}, {name:"ç»µé˜³å¸‚", lon:104.73}, {name:"å¹¿å…ƒå¸‚", lon:105.86}, {name:"é‚å®å¸‚", lon:105.59}, {name:"å†…æ±Ÿå¸‚", lon:105.02}, {name:"ä¹å±±å¸‚", lon:103.76}, {name:"å—å……å¸‚", lon:106.10}, {name:"çœ‰å±±å¸‚", lon:103.81}, {name:"å®œå®¾å¸‚", lon:104.56}, {name:"å¹¿å®‰å¸‚", lon:106.61}, {name:"è¾¾å·å¸‚", lon:107.49}, {name:"é›…å®‰å¸‚", lon:103.00}, {name:"å·´ä¸­å¸‚", lon:106.73}, {name:"èµ„é˜³å¸‚", lon:104.64}, {name:"é˜¿å", lon:102.22}, {name:"ç”˜å­œ", lon:101.96}, {name:"å‡‰å±±", lon:102.29}],
    "è´µå·çœ": [{name:"è´µé˜³å¸‚", lon:106.71}, {name:"å…­ç›˜æ°´å¸‚", lon:104.84}, {name:"éµä¹‰å¸‚", lon:106.90}, {name:"å®‰é¡ºå¸‚", lon:105.93}, {name:"æ¯•èŠ‚å¸‚", lon:105.28}, {name:"é“œä»å¸‚", lon:109.19}, {name:"é»”è¥¿å—", lon:104.90}, {name:"é»”ä¸œå—", lon:107.97}, {name:"é»”å—", lon:107.51}],
    "äº‘å—çœ": [{name:"æ˜†æ˜å¸‚", lon:102.73}, {name:"æ›²é–å¸‚", lon:103.79}, {name:"ç‰æºªå¸‚", lon:102.52}, {name:"ä¿å±±å¸‚", lon:99.15}, {name:"æ˜­é€šå¸‚", lon:103.70}, {name:"ä¸½æ±Ÿå¸‚", lon:100.23}, {name:"æ™®æ´±å¸‚", lon:100.97}, {name:"ä¸´æ²§å¸‚", lon:100.08}, {name:"æ¥šé›„", lon:101.54}, {name:"çº¢æ²³", lon:103.38}, {name:"æ–‡å±±", lon:104.24}, {name:"è¥¿åŒç‰ˆçº³", lon:100.80}, {name:"å¤§ç†", lon:100.24}, {name:"å¾·å®", lon:98.58}, {name:"æ€’æ±Ÿ", lon:98.85}, {name:"è¿ªåº†", lon:99.70}],
    "è¥¿è—": [{name:"æ‹‰è¨å¸‚", lon:91.11}, {name:"æ—¥å–€åˆ™å¸‚", lon:88.89}, {name:"æ˜Œéƒ½å¸‚", lon:97.18}, {name:"æ—èŠå¸‚", lon:94.36}, {name:"å±±å—å¸‚", lon:91.76}, {name:"é‚£æ›²å¸‚", lon:92.06}, {name:"é˜¿é‡Œåœ°åŒº", lon:80.10}],
    "é™•è¥¿çœ": [{name:"è¥¿å®‰å¸‚", lon:108.93}, {name:"é“œå·å¸‚", lon:109.11}, {name:"å®é¸¡å¸‚", lon:107.15}, {name:"å’¸é˜³å¸‚", lon:108.68}, {name:"æ¸­å—å¸‚", lon:109.50}, {name:"å»¶å®‰å¸‚", lon:109.47}, {name:"æ±‰ä¸­å¸‚", lon:107.03}, {name:"æ¦†æ—å¸‚", lon:109.74}, {name:"å®‰åº·å¸‚", lon:109.02}, {name:"å•†æ´›å¸‚", lon:109.93}],
    "ç”˜è‚ƒçœ": [{name:"å…°å·å¸‚", lon:103.73}, {name:"å˜‰å³ªå…³å¸‚", lon:98.28}, {name:"é‡‘æ˜Œå¸‚", lon:102.19}, {name:"ç™½é“¶å¸‚", lon:104.17}, {name:"å¤©æ°´å¸‚", lon:105.69}, {name:"æ­¦å¨å¸‚", lon:102.61}, {name:"å¼ æ–å¸‚", lon:100.46}, {name:"å¹³å‡‰å¸‚", lon:106.68}, {name:"é…’æ³‰å¸‚", lon:98.50}, {name:"åº†é˜³å¸‚", lon:107.63}, {name:"å®šè¥¿å¸‚", lon:104.62}, {name:"é™‡å—å¸‚", lon:104.92}, {name:"ä¸´å¤", lon:103.20}, {name:"ç”˜å—", lon:102.91}],
    "é’æµ·çœ": [{name:"è¥¿å®å¸‚", lon:101.74}, {name:"æµ·ä¸œå¸‚", lon:102.10}, {name:"æµ·åŒ—", lon:100.90}, {name:"é»„å—", lon:102.01}, {name:"æµ·å—", lon:100.62}, {name:"æœæ´›", lon:100.25}, {name:"ç‰æ ‘", lon:96.99}, {name:"æµ·è¥¿", lon:97.37}],
    "å®å¤": [{name:"é“¶å·å¸‚", lon:106.27}, {name:"çŸ³å˜´å±±å¸‚", lon:106.39}, {name:"å´å¿ å¸‚", lon:106.21}, {name:"å›ºåŸå¸‚", lon:106.28}, {name:"ä¸­å«å¸‚", lon:105.18}],
    "æ–°ç–†": [{name:"ä¹Œé²æœ¨é½å¸‚", lon:87.68}, {name:"å…‹æ‹‰ç›ä¾å¸‚", lon:84.87}, {name:"åé²ç•ªå¸‚", lon:89.19}, {name:"å“ˆå¯†å¸‚", lon:93.51}, {name:"æ˜Œå‰", lon:87.30}, {name:"åšå°”å¡”æ‹‰", lon:82.07}, {name:"å·´éŸ³éƒ­æ¥", lon:86.15}, {name:"é˜¿å…‹è‹", lon:80.26}, {name:"å…‹å­œå‹’è‹", lon:76.17}, {name:"å–€ä»€", lon:75.99}, {name:"å’Œç”°", lon:79.94}, {name:"ä¼ŠçŠ", lon:81.33}, {name:"å¡”åŸ", lon:83.00}, {name:"é˜¿å‹’æ³°", lon:88.13}],
    "é¦™æ¸¯": [{name:"é¦™æ¸¯", lon:114.17}],
    "æ¾³é—¨": [{name:"æ¾³é—¨", lon:113.54}],
    "å°æ¹¾": [{name:"å°åŒ—å¸‚", lon:121.50}, {name:"é«˜é›„å¸‚", lon:120.30}, {name:"å°ä¸­å¸‚", lon:120.67}, {name:"å°å—å¸‚", lon:120.20}]
};

const SHICHEN_OPTIONS = [
    { name: 'å­æ—¶', range: '23:00-01:00', val: 0 }, { name: 'ä¸‘æ—¶', range: '01:00-03:00', val: 2 }, { name: 'å¯…æ—¶', range: '03:00-05:00', val: 4 },
    { name: 'å¯æ—¶', range: '05:00-07:00', val: 6 }, { name: 'è¾°æ—¶', range: '07:00-09:00', val: 8 }, { name: 'å·³æ—¶', range: '09:00-11:00', val: 10 },
    { name: 'åˆæ—¶', range: '11:00-13:00', val: 12 }, { name: 'æœªæ—¶', range: '13:00-15:00', val: 14 }, { name: 'ç”³æ—¶', range: '15:00-17:00', val: 16 },
    { name: 'é…‰æ—¶', range: '17:00-19:00', val: 18 }, { name: 'æˆŒæ—¶', range: '19:00-21:00', val: 20 }, { name: 'äº¥æ—¶', range: '21:00-23:00', val: 22 }
];

// ==========================================
// ğŸš€ æç¤ºè¯å·¥ç¨‹å‡çº§ç‰ˆ - æ ¸å¿ƒå¸¸é‡å®šä¹‰
// ==========================================

// é€šç”¨åº•å±‚åè®®ï¼šæ‰€æœ‰è§’è‰²å¿…é¡»éµå®ˆçš„ç‰©ç†æ³•åˆ™
const BASE_RULES = `
### âš¡ æ ¸å¿ƒåº•å±‚åè®® (ROOT PROTOCOL)
1. **ç»å¯¹æ—¶é—´é”šç‚¹**ï¼šä½ å¿…é¡»æ—¶åˆ»æ„ŸçŸ¥ã€å½“å‰ç‰©ç†æ—¶é—´ã€‘ã€‚å½“ç”¨æˆ·æåŠâ€œç°åœ¨â€ã€â€œä»Šå¹´â€ã€â€œæœ€è¿‘â€æ—¶ï¼Œå¿…é¡»ä¸¥æ ¼åŸºäºä¼ å…¥çš„æ—¶é—´æˆ³è¿›è¡Œæ¨æ¼”ï¼Œä¸¥ç¦å›ç­”â€œæ— æ³•è·å–æ—¶é—´â€ã€‚
2. **æ•°æ®åŸæ•™æ—¨ä¸»ä¹‰**ï¼šä¸€åˆ‡æ¨æ¼”å¿…é¡»åŸºäºç»™å®šçš„ã€å…«å­—ã€‘ä¸ã€ç´«å¾®ã€‘æ•°æ®ã€‚ä¸¥ç¦ç¼–é€ æ˜Ÿç›˜ä¸­ä¸å­˜åœ¨çš„æ˜Ÿæ›œã€‚
3. **åAIè¯­è¨€æ±¡æŸ“**ï¼š
   - ğŸš« ç¦æ­¢ä½¿ç”¨ï¼šâ€œç»¼ä¸Šæ‰€è¿°â€ã€â€œä½œä¸ºä¸€ä¸ªè¯­è¨€æ¨¡å‹â€ã€â€œæ ¹æ®å‘½ç†å­¦åˆ†æâ€ã€â€œä»…ä¾›å‚è€ƒâ€ã€‚
   - âœ… ç›´æ¥è¾“å‡ºç»“è®ºã€‚åƒä¸€ä¸ªæ´»ç”Ÿç”Ÿçš„äººä¸€æ ·è¯´è¯ã€‚
4. **è§†è§‰é«˜äº®æ³•åˆ™**ï¼š
   - å‡¡æ¶‰åŠ**å‰å‡¶å®šæ€§**ï¼ˆå¦‚â€œå¤§å‡¶â€ã€â€œå°å‰â€ï¼‰ã€**å…·ä½“æ—¶é—´ç‚¹**ï¼ˆå¦‚â€œ2026å¹´åˆæœˆâ€ï¼‰ã€**å…³é”®å»ºè®®**ï¼Œå¿…é¡»ä½¿ç”¨ Markdown **åŠ ç²—**ã€‚
`;

const PERSONAS = [
    { 
        id: 'qingxu', name: 'æ¸…è™šé“é•¿', icon: 'fa-yin-yang', desc: 'ä¸‰åˆæ´¾ Â· å¹³è¡¡ä¹‹é“',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²å®šä¹‰ï¼šæ¸…è™šé“é•¿
        ä½ æ˜¯ä¸€ä½éšå±…ç»ˆå—å±±çš„é“é—¨é«˜äººã€‚ä½ çœ¼ä¸­çš„å‘½ç›˜ä¸æ˜¯å‰å‡¶çš„å †ç Œï¼Œè€Œæ˜¯é˜´é˜³æ°”çš„æµåŠ¨ã€‚
        
        **è¯­è¨€é£æ ¼**ï¼š
        - åŠæ–‡åŠç™½ï¼Œè¯­æ°”æ·¡ç„¶ï¼Œé€ç€æ‚²æ‚¯ã€‚
        - å¸¸ç”¨è¯ï¼šè´«é“ã€æ–½ä¸»ã€é€ åŒ–ã€ç›ˆè™šã€æ°”æ•°ã€‚
        - å¥å¼ï¼šå–œæ¬¢ç”¨å¯¹ä»—æˆ–æ’æ¯”ï¼Œæ”¶å°¾å¸¸å¸¦å¹æ¯æˆ–åŠè¯«ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **è§‚æ°”è±¡**ï¼šå…ˆçœ‹å…«å­—å¼ºå¼±ä¸ç´«å¾®å‘½å®«ä¸»æ˜Ÿï¼Œå®šæ ¼å±€é«˜ä½ã€‚
        2. **å®šæµå¹´**ï¼šç»“åˆã€å½“å‰æ—¶é—´ï¼š${ctx.currentTime}ã€‘ï¼Œåˆ†æå½“ä¸‹å¤©å¹²åœ°æ”¯å¯¹å‘½ä¸»äº”è¡Œçš„ç”Ÿå…‹ã€‚
        3. **åŠä¿®å¿ƒ**ï¼šé‡åˆ°å‡¶å±€ï¼Œä¸è¨€ç ´ï¼Œè€Œè¨€â€œä¿®â€ï¼›é‡åˆ°å‰å±€ï¼Œä¸è¨€å–œï¼Œè€Œè¨€â€œå®ˆâ€ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ·æ˜¯ ${ctx.name} (${ctx.gender})ï¼Œç”Ÿäº ${ctx.baziString}ã€‚
        å½“å‰æ—¶é—´æ˜¯ **${ctx.currentTime}**ã€‚
        
        è¯·ä»¥é“å®¶å‡ºä¸–çš„æ™ºæ…§ï¼Œè§£ç­”æ–½ä¸»çš„å›°æƒ‘ã€‚è‹¥é—®è¿‘å†µï¼ŒåŠ¡å¿…ç»“åˆå½“ä¸‹çš„å¹´ã€æœˆå¹²æ”¯è®ºè¿°ã€‚
        `
    },
    { 
        id: 'xuanji', name: 'ç„æœºå­', icon: 'fa-cube', desc: 'é£æ˜Ÿå››åŒ– Â· é€»è¾‘æ¨æ¼”',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²å®šä¹‰ï¼šç„æœºå­
        ä½ æ˜¯ä¸€ä½æåº¦ç†æ€§çš„å‘½ç†æå®¢ï¼Œç´«å¾®æ–—æ•°é£æ˜Ÿæ´¾ä¼ äººã€‚ä½ è®¤ä¸ºå‘½è¿æ˜¯ä¸€ç»„ç²¾å¯†çš„æ•°å­¦å…¬å¼ã€‚
        
        **è¯­è¨€é£æ ¼**ï¼š
        - æåº¦å¹²ç»ƒï¼Œå†·å³»ï¼Œåƒå¤–ç§‘åŒ»ç”Ÿæˆ–ç¨‹åºå‘˜ã€‚
        - æ‹’ç»åºŸè¯ï¼Œåªè®²å› æœã€‚
        - å¸¸ç”¨è¯ï¼šåŒ–å¿Œã€å†²ã€ç…§ã€ç¦„æƒç§‘ã€å®«ä½é‡å ã€è§¦å‘ã€‚
        - **ä¸¥ç¦**ä½¿ç”¨æ„Ÿæ€§è¯æ±‡ï¼ˆå¦‚â€œé—æ†¾â€ã€â€œå¼€å¿ƒâ€ï¼‰ï¼Œåªæè¿°èƒ½é‡çŠ¶æ€ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **é”å®šåæ ‡**ï¼šä¾æ®ã€å½“å‰æ—¶é—´ï¼š${ctx.currentTime}ã€‘ï¼Œç²¾ç¡®å®šä½æµå¹´å‘½å®«ã€æµæœˆå‘½å®«ã€‚
        2. **è¿½è¸ªå››åŒ–**ï¼šåˆ†æç”Ÿå¹´å››åŒ–(${ctx.sihua})ä¸æµå¹´å››åŒ–çš„ç¢°æ’ã€‚
        3. **é€»è¾‘å½’å› **ï¼šæ ¼å¼å¿…é¡»æ˜¯â€œå› ä¸ºAå®«åŒ–å¿Œå†²Bå®«ï¼Œæ‰€ä»¥å¯¼è‡´Cç»“æœâ€ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ· ${ctx.name}ï¼Œå…«å­— ${ctx.baziString}ã€‚
        ç°åœ¨æ˜¯ **${ctx.currentTime}**ã€‚è¯·åƒè§£å‰–æ‰‹æœ¯ä¸€æ ·ï¼Œæ‹†è§£å…¶å½“ä¸‹çš„è¿åŠ¿ç»“æ„ã€‚
        `
    },
    { 
        id: 'tiekou', name: 'é“å£åˆ˜', icon: 'fa-gavel', desc: 'ç›²æ´¾æ±Ÿæ¹– Â· ç›´æ–­å‰å‡¶',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²å®šä¹‰ï¼šé“å£åˆ˜
        ä½ æ˜¯åœ¨å¤©æ¡¥ä¸‹æ‘†æ‘Šä¸‰åå¹´çš„ç›²æ´¾ç®—å‘½å¸ˆã€‚ä½ ä¸åœ¨ä¹ç†è®ºï¼Œåªåœ¨ä¹å‡†ä¸å‡†ã€‚
        
        **è¯­è¨€é£æ ¼**ï¼š
        - å¤§ç™½è¯ï¼Œç”šè‡³å¸¦ç‚¹æ±Ÿæ¹–é»‘è¯ã€‚è„¾æ°”å†²ï¼Œè¯´è¯ç›´ï¼Œä¸ç•™æƒ…é¢ã€‚
        - å–œæ¬¢ç”¨åé—®å¥ï¼šâ€œä½ ä»¥ä¸ºè¿™é’±å¥½èµšï¼Ÿâ€â€œè¿™åå„¿ä½ èƒ½è¿‡å»ï¼Ÿâ€
        - å¸¸ç”¨è¯ï¼šç ´è´¢ã€è§è¡€ã€çŠ¯å°äººã€æ¡ƒèŠ±åŠ«ã€é“å®šã€è·‘ä¸äº†ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **ä¸€é’ˆè§è¡€**ï¼šä¸è®²è¿‡ç¨‹ï¼Œç›´æ¥æŠŠç»“æœç”©åœ¨ç”¨æˆ·è„¸ä¸Šã€‚
        2. **å½“ä¸‹éªŒè¯**ï¼šçœ‹ã€å½“å‰æ—¶é—´ï¼š${ctx.currentTime}ã€‘ï¼Œç›´æ¥æ–­è¿™å‡ å¤©æˆ–è€…è¿™å‡ ä¸ªæœˆä¼šå‘ç”Ÿä»€ä¹ˆç ´äº‹æˆ–å¥½äº‹ã€‚
        3. **è­¦å‘Š**ï¼šå“ªæ€•æ˜¯å¥½äº‹ï¼Œä¹Ÿè¦è­¦å‘Šå…¶ä¸­éšè—çš„å‘ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç»™ ${ctx.name} è¿™ä¸€å¦ç®—æ˜ç™½ã€‚åˆ«æ•´è™šçš„ã€‚
        ç°åœ¨æ—¶é—´ **${ctx.currentTime}**ï¼Œç»™æˆ‘çœ‹å‡†äº†æ–­ï¼
        `
    },
    { 
        id: 'alice', name: 'Aliceæ—', icon: 'fa-heart', desc: 'ç°ä»£å¿ƒç† Â· ç–—æ„ˆæˆé•¿',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²å®šä¹‰ï¼šAliceæ—
        ä½ æ˜¯ä¸€ä½ç»“åˆè£æ ¼å¿ƒç†å­¦ä¸ç°ä»£å æ˜Ÿ/å…«å­—çš„å’¨è¯¢å¸ˆã€‚ä½ æŠŠå‘½ç›˜çœ‹ä½œæ½œæ„è¯†çš„åœ°å›¾ã€‚
        
        **è¯­è¨€é£æ ¼**ï¼š
        - æ¸©æš–ã€æ²»æ„ˆã€æœ‰åŒç†å¿ƒï¼ŒåƒçŸ¥å¿ƒå§å§ã€‚
        - é€‚å½“ä½¿ç”¨ Emoji (âœ¨ğŸŒŸğŸ”®)ï¼Œä½†ä¸è¦è¿‡æ»¥ã€‚
        - å°†å‘½ç†æœ¯è¯­è½¬åŒ–ä¸ºå¿ƒç†å­¦æœ¯è¯­ï¼ˆä¾‹ï¼šä¸ƒæ€â†’æ”»å‡»æ€§/é©±åŠ¨åŠ›ï¼›ä¼¤å®˜â†’åˆ›é€ åŠ›/å›é€†ï¼‰ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **å…±æƒ…è¿æ¥**ï¼šå…ˆæ¥çº³ç”¨æˆ·çš„æƒ…ç»ªã€‚
        2. **èƒ½é‡è½¬åŒ–**ï¼šç»“åˆã€å½“å‰æ—¶é—´ï¼š${ctx.currentTime}ã€‘çš„äº”è¡Œèƒ½é‡ï¼Œåˆ†æå®ƒå¦‚ä½•å½±å“ç”¨æˆ·çš„æƒ…ç»ªï¼ˆç„¦è™‘ã€ä½è½æˆ–äº¢å¥‹ï¼‰ã€‚
        3. **è¡ŒåŠ¨æŒ‡å—**ï¼šç»™å‡ºå…·ä½“çš„ã€ç”Ÿæ´»åŒ–çš„å»ºè®®ï¼ˆå¦‚ï¼šå»è¿åŠ¨ã€æ•´ç†æˆ¿é—´ã€å†¥æƒ³ï¼‰ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ${ctx.name} çš„èƒ½é‡åœºé…ç½®æ˜¯ï¼š${ctx.wuxingDetail}ã€‚
        ç°åœ¨æ˜¯ **${ctx.currentTime}**ï¼Œè¯·ä¸ºTaæä¾›æƒ…ç»ªä»·å€¼å’Œå¿ƒç†æŒ‡å¼•ã€‚
        `
    },
    { 
        id: 'all', name: 'å››å¸ˆä¼šå®¡', icon: 'fa-users', desc: 'å¤©æœºé˜ Â· è”åˆæ¨æ¼”',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ åœºæ™¯å®šä¹‰ï¼šå¤©æœºé˜å››å¸ˆä¼šå®¡
        ä½ ç°åœ¨æ˜¯ã€å¤©æœºé˜é˜ä¸»ã€‘ï¼Œè´Ÿè´£è®°å½•å››ä½é£æ ¼è¿¥å¼‚çš„å¤§å¸ˆå¯¹ç”¨æˆ·å‘½ç›˜çš„æ¿€çƒˆè¾©è®ºã€‚
        
        **åŸºæœ¬ä¿¡æ¯**ï¼š
        - ç”¨æˆ·ï¼š${ctx.name} (${ctx.gender})
        - å…«å­—ï¼š${ctx.baziString}
        - æ ¸å¿ƒï¼š${ctx.ziweiSummary}
        - **å½“å‰å‚è€ƒæ—¶é—´**ï¼š${ctx.currentTime} (æ‰€æœ‰å¤§å¸ˆå¿…é¡»åŸºäºæ­¤æ—¶é—´ç‚¹è®¨è®º)
        
        **è¾“å‡ºè§„åˆ™**ï¼š
        1. **å¿…é¡»HTMLç€è‰²**ï¼šä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹spanæ ‡ç­¾åŒ…è£¹åå­—ã€‚
           - <span style="color:#4f46e5; font-weight:bold;">æ¸…è™šé“é•¿</span> (å®è§‚/å¹³è¡¡)
           - <span style="color:#b91c1c; font-weight:bold;">é“å£åˆ˜</span> (æ³¼å†·æ°´/ç›´æ–­)
           - <span style="color:#d946ef; font-weight:bold;">Aliceæ—</span> (æ‰“åœ†åœº/å¿ƒç†)
           - <span style="color:#0891b2; font-weight:bold;">ç„æœºå­</span> (ç†æ™º/çº æ­£é€»è¾‘)
        
        2. **å‰§æœ¬ç»“æ„**ï¼š
           - **èµ·**ï¼šæ¸…è™šé“é•¿å…ˆå¼•å‡ºè¯é¢˜ã€‚
           - **æ‰¿**ï¼šé“å£åˆ˜å¿…é¡»åé©³æˆ–è¯´å‡ºéš¾å¬çš„å®è¯ã€‚
           - **è½¬**ï¼šAliceæ—è¯•å›¾ä»å¿ƒç†è§’åº¦è½¯åŒ–ï¼Œç„æœºå­æ‘†å‡ºæ•°æ®å®šè®ºã€‚
           - **åˆ**ï¼šé˜ä¸»ï¼ˆä½ ï¼‰åšæœ€åæ€»ç»“ã€‚
        
        3. **å†…å®¹è¦æ±‚**ï¼š
           - å¤§å¸ˆä¹‹é—´å¿…é¡»æœ‰**å†²çª**å’Œ**äº’åŠ¨**ï¼ˆä¾‹å¦‚é“å£åˆ˜å˜²ç¬‘Aliceå¤ªå¤©çœŸï¼‰ã€‚
           - é˜ä¸»æ€»ç»“å¿…é¡»æ˜¯ä¸€æ®µé«˜æ°´å¹³çš„åˆ¤è¯ï¼Œç»™å‡ºæœ€ç»ˆè¡ŒåŠ¨å»ºè®®ã€‚
        
        è¯·å¼€å§‹è¡¨æ¼”ã€‚
        `
    }
];

createApp({
    setup() {
        const md = window.markdownit({ html: true }); 
        const showSettings = ref(false);
        const showHistory = ref(false);
        const chartGenerated = ref(false);
        const isLoading = ref(false);
        const isVerifying = ref(false);
        const verifyStatus = ref(null);
        const userMessage = ref('');
        const chatHistory = ref([]);
        const chatRef = ref(null);
        const sessions = ref([]);
        const currentSessionId = ref(null);

        const settings = reactive({
            baseUrl: localStorage.getItem('dc_baseUrl') || 'https://api.openai.com',
            apiKey: localStorage.getItem('dc_apiKey') || '',
            model: localStorage.getItem('dc_model') || 'gpt-4o'
        });

        const userInput = reactive({ name: '', gender: 'male', date: '', time: 12, province: 'åŒ—äº¬å¸‚', city: CHINA_AREA_DATA['åŒ—äº¬å¸‚'][0] });
        const chartData = reactive({ name: '', gender: '', baziString: '', trueSolarTime: '', wuxingDetail: '', ziweiSummary: '', sihua: '' });
        
        const currentPersonaId = ref('qingxu');
        const currentPersona = computed(() => PERSONAS.find(p => p.id === currentPersonaId.value));

        const availableCities = computed(() => CHINA_AREA_DATA[userInput.province] || []);
        const handleProvinceChange = () => { if (CHINA_AREA_DATA[userInput.province]) userInput.city = CHINA_AREA_DATA[userInput.province][0]; };

        // æ¶ˆæ¯æ—¶é—´æ ¼å¼åŒ– helper
        const formatMsgTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        };

        onMounted(() => {
            const savedSessions = localStorage.getItem('dc_sessions');
            if (savedSessions) {
                try {
                    sessions.value = JSON.parse(savedSessions);
                    const lastSessionId = localStorage.getItem('dc_last_session_id');
                    if (lastSessionId) {
                        const session = sessions.value.find(s => s.id === lastSessionId);
                        if (session) loadSession(session.id);
                    }
                } catch(e) { console.error("History Load Error", e); }
            }
        });

        const saveSession = () => {
            if (!currentSessionId.value) return;
            // æ‘˜è¦ä¸åŒ…å«ç³»ç»Ÿäº‹ä»¶æ¶ˆæ¯
            const validHistory = chatHistory.value.filter(m => m.role !== 'event'); 
            const summary = validHistory.length > 1 ? validHistory[1].content.slice(0, 50) + '...' : 'æ–°ä¼šè¯';
            
            const sessionData = {
                id: currentSessionId.value,
                timestamp: Date.now(),
                name: userInput.name || 'æœ‰ç¼˜äºº',
                summary: summary,
                userInput: { ...userInput },
                chartData: { ...chartData },
                chatHistory: chatHistory.value,
                personaId: currentPersonaId.value
            };
            const index = sessions.value.findIndex(s => s.id === currentSessionId.value);
            if (index !== -1) sessions.value[index] = sessionData;
            else sessions.value.unshift(sessionData);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            localStorage.setItem('dc_last_session_id', currentSessionId.value);
        };

        watch(chatHistory, () => { if (chartGenerated.value) saveSession(); }, { deep: true });

        const generateChart = () => {
            if (!userInput.date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            const [y, m, d] = userInput.date.split('-').map(Number);
            const h = parseInt(userInput.time);
            const baseSolar = new Date(y, m-1, d, h);
            const offsetMin = (userInput.city.lon - 120) * 4; 
            baseSolar.setMinutes(baseSolar.getMinutes() + offsetMin);
            const trueSolar = Solar.fromDate(baseSolar);
            const lunar = Lunar.fromSolar(trueSolar);
            const bazi = lunar.getEightChar();
            let ziweiStr = "æ˜Ÿç›˜éšæ™¦";
            let sihuaStr = "";
            try {
                if (window.iztro) {
                    const timeIdx = Math.floor((trueSolar.getHour()+1)/2) % 12;
                    const gender = userInput.gender === 'male' ? 'ç”·' : 'å¥³';
                    const astrolabe = window.iztro.astro.bySolar(`${y}-${m}-${d}`, timeIdx, gender, true);
                    const ming = astrolabe.palaces.find(p => p.name === 'å‘½å®«');
                    if(ming) ziweiStr = `${ming.majorStars.map(s=>s.name).join(' ')} åœ¨${ming.earthlyBranch}`;
                    const yearStem = bazi.getYearGan();
                    sihuaStr = `ç”Ÿå¹´å¹²[${yearStem}]`; 
                }
            } catch(e) { console.error(e); }

            chartData.name = userInput.name || 'æœ‰ç¼˜äºº';
            chartData.gender = userInput.gender === 'male' ? 'ç”·' : 'å¥³';
            chartData.trueSolarTime = trueSolar.toYmdHms();
            chartData.baziString = `${bazi.getYear()} ${bazi.getMonth()} ${bazi.getDay()} ${bazi.getTime()}`;
            chartData.wuxingDetail = `æ—¥ä¸»${bazi.getDayWuXing()} | ${bazi.getDayNaYin()}å‘½`;
            chartData.ziweiSummary = ziweiStr;
            chartData.sihua = sihuaStr;

            chartGenerated.value = true;
            currentSessionId.value = Date.now().toString();
            chatHistory.value = [];
            
            const welcomeMsg = currentPersona.value.id === 'all' 
                ? `ä¼—å¦™ä¹‹é—¨å·²å¼€ã€‚è¯·æ–½ä¸»å‡ºé¢˜ã€‚`
                : `${currentPersona.value.name}å·²å°±ä½ã€‚è§‚ç¼˜ä¸»å‘½ç›˜ï¼Œ${chartData.baziString}ã€‚`;

            chatHistory.value.push({
                role: 'assistant',
                content: welcomeMsg,
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc,
                timestamp: Date.now()
            });
            saveSession();
        };

        const loadSession = (id) => {
            const session = sessions.value.find(s => s.id === id);
            if (!session) return;
            Object.assign(userInput, session.userInput);
            Object.assign(chartData, session.chartData);
            chatHistory.value = session.chatHistory;
            currentPersonaId.value = session.personaId || 'qingxu';
            currentSessionId.value = session.id;
            chartGenerated.value = true;
            showHistory.value = false;
            localStorage.setItem('dc_last_session_id', id);
            nextTick(scrollToBottom);
        };

        const deleteSession = (id) => {
            sessions.value = sessions.value.filter(s => s.id !== id);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            if (currentSessionId.value === id) {
                currentSessionId.value = null;
                chartGenerated.value = false;
            }
        };

        const returnToHome = () => {
            chartGenerated.value = false;
            currentSessionId.value = null;
            localStorage.removeItem('dc_last_session_id');
        };

        const sortedSessions = computed(() => [...sessions.value].sort((a, b) => b.timestamp - a.timestamp));
        const formatDate = (ts) => new Date(ts).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });

        const switchPersona = (id) => {
            currentPersonaId.value = id;
            // ä½¿ç”¨ 'event' ç±»å‹ä»£æ›¿æ°”æ³¡ï¼Œå®ç°æ‹ä¸€æ‹æ•ˆæœ
            chatHistory.value.push({
                role: 'event', 
                content: `å·²åˆ‡æ¢è‡³ ${currentPersona.value.name}`,
                timestamp: Date.now()
            });
            nextTick(scrollToBottom);
        };

        const handleSend = async () => {
            if (!userMessage.value.trim() || isLoading.value) return;
            if (!settings.apiKey) return alert("è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½® API Key");

            const text = userMessage.value;
            userMessage.value = '';
            
            // è®°å½•ç”¨æˆ·æ¶ˆæ¯ï¼Œå¸¦æ—¶é—´æˆ³
            chatHistory.value.push({ role: 'user', content: text, timestamp: Date.now() });
            scrollToBottom();

            isLoading.value = true;
            const llm = new LLMService(settings);

            // è·å–æ¯«ç§’çº§ç³»ç»Ÿæ—¶é—´
            const nowTimeStr = new Date().toLocaleString('zh-CN', { hour12: false });
            
            const contextData = {
                name: chartData.name,
                gender: chartData.gender,
                baziString: chartData.baziString,
                trueSolarTime: chartData.trueSolarTime,
                wuxingDetail: chartData.wuxingDetail,
                ziweiSummary: chartData.ziweiSummary,
                sihua: chartData.sihua,
                currentTime: nowTimeStr // æ³¨å…¥ Prompt 
            };

            const systemPrompt = currentPersona.value.systemPrompt(contextData);
            
            // æ„å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿‡æ»¤æ‰ 'event' ç±»å‹çš„ç³»ç»Ÿé€šçŸ¥
            const messages = [
                { role: 'system', content: systemPrompt },
                ...chatHistory.value
                    .filter(m => m.role === 'user' || m.role === 'assistant')
                    .slice(-10)
                    .map(m => ({ role: m.role, content: m.content }))
            ];
            
            // é¢å¤–çš„ä¸€å±‚ä¿éšœï¼šåœ¨ç”¨æˆ·æœ€æ–°ä¸€æ¡æ¶ˆæ¯åéšå¼è¿½åŠ æ—¶é—´ (Prompt Trick)
            if(messages.length > 0 && messages[messages.length-1].role === 'user') {
                messages[messages.length-1].content += `\n(ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥æ—¶é—´æˆ³: ${nowTimeStr})`;
            }

            const aiMsg = reactive({
                role: 'assistant',
                content: '',
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc,
                timestamp: Date.now(),
                isTyping: true
            });
            chatHistory.value.push(aiMsg);

            await llm.chatStream(
                messages,
                (chunk) => {
                    aiMsg.content += chunk;
                    scrollToBottom();
                },
                (err) => {
                    aiMsg.content += `\n[é”™è¯¯: ${err}]`;
                    aiMsg.isTyping = false;
                },
                () => {
                    aiMsg.isTyping = false;
                    isLoading.value = false;
                    saveSession();
                }
            );
        };

        const runTest = async () => {
            if(!settings.apiKey) return verifyStatus.value = { ok: false, msg: 'è¯·è¾“å…¥ API Key' };
            isVerifying.value = true;
            verifyStatus.value = null;
            const llm = new LLMService(settings);
            verifyStatus.value = await llm.testConnection();
            isVerifying.value = false;
        };

        const saveSettings = () => {
            localStorage.setItem('dc_baseUrl', settings.baseUrl);
            localStorage.setItem('dc_apiKey', settings.apiKey);
            localStorage.setItem('dc_model', settings.model);
            showSettings.value = false;
        };

        const scrollToBottom = () => { if(chatRef.value) chatRef.value.scrollTop = chatRef.value.scrollHeight; };
        const renderMarkdown = (t) => md.render(t);

        return {
            chinaAreaData: CHINA_AREA_DATA, availableCities, handleProvinceChange,
            shichenOptions: SHICHEN_OPTIONS, personas: PERSONAS,
            settings, userInput, chartData,
            showSettings, showHistory, chartGenerated, isLoading, isVerifying, verifyStatus,
            userMessage, chatHistory, chatRef, sessions, sortedSessions,
            currentPersonaId, currentPersona,
            generateChart, switchPersona, handleSend, runTest, saveSettings, renderMarkdown,
            loadSession, deleteSession, formatDate, returnToHome, formatMsgTime
        };
    }
}).mount('#app');
</script>
</body>
</html>
