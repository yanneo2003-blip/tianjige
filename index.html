<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©æœºé˜ | DivineChat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro@2.0.5/dist/iztro.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Noto Serif SC', 'serif'],
                    },
                    colors: {
                        stone: { 50:'#fafaf9', 100:'#f5f5f4', 200:'#e7e5e4', 300:'#d6d3d1', 400:'#a8a29e', 500:'#78716c', 800:'#292524', 900:'#1c1917' },
                        gold: { DEFAULT: '#b49b7e' }
                    },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)', 'float': '0 10px 40px -10px rgba(0, 0, 0, 0.08)' }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #fafaf9; color: #1c1917; -webkit-font-smoothing: antialiased; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .input-underline { position: relative; }
        .input-underline::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background-color: #1c1917; transition: width 0.3s ease; }
        .input-wrapper:focus-within .input-underline::after { width: 100%; }
        
        .typing-dot { width: 4px; height: 4px; background-color: #a8a29e; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Prose Styling Upgrade */
        .prose p { margin-bottom: 1rem; line-height: 1.8; font-size: 0.95rem; color: #44403c; }
        /* ç¡®ä¿æ°”æ³¡å†…æœ€åä¸€ä¸ªå…ƒç´ æ²¡æœ‰ä¸‹è¾¹è·ï¼Œä¿æŒç´§å‡‘ */
        .prose > :last-child { margin-bottom: 0; }
        
        .prose h1, .prose h2, .prose h3 { font-family: 'Noto Serif SC', serif; color: #1c1917; margin-top: 1.5rem; margin-bottom: 0.8rem; font-weight: 700; border-bottom: 1px dashed #d6d3d1; padding-bottom: 0.2rem; }
        .prose ul { list-style-type: none; padding-left: 0; color: #57534e; }
        
        /* é‡ç‚¹é«˜äº®æ•ˆæœ - ä¿®å¤ç‰ˆ (åœ†è§’æŸ”å…‰) */
        .prose strong { 
            color: #7f1d1d; /* æ·±çº¢è‰²æ–‡å­—ï¼Œå¢å¼ºå¯¹æ¯” */
            font-weight: 600; 
            background-color: #fee2e2; /* æŸ”å’Œçš„çº¢è‰²èƒŒæ™¯ */
            padding: 0.1em 0.3em;
            border-radius: 0.3em; /* åœ†è§’ï¼Œä¿è¯ä¸¤å¤´å½¢çŠ¶ä¸€è‡´ */
            box-decoration-break: clone; /* æ¢è¡Œæ—¶ä¿æŒæ ·å¼ */
            -webkit-box-decoration-break: clone;
        }

        /* å¼•ç”¨å—æ”¹ä¸ºâ€œå¡ç‰‡â€æ ·å¼ */
        .prose blockquote { 
            border: 1px solid #e7e5e4;
            background: #ffffff;
            padding: 1rem 1.2rem; 
            border-radius: 12px; 
            margin: 1.5rem 0; 
            font-size: 0.9rem; 
            color: #57534e;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            font-family: 'Inter', sans-serif;
        }
        .prose blockquote p { margin-bottom: 0.5rem; }
        /* å¡ç‰‡å†…çš„æ ‡é¢˜ç‰¹æ®Šå¤„ç†ï¼Œä¸ä½¿ç”¨é«˜äº®èƒŒæ™¯ */
        .prose blockquote strong { background: none; color: #b49b7e; padding: 0; font-weight: 700; } 

        .prose hr { border-top: 1px solid #e7e5e4; margin: 2rem 0; width: 50%; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center">

    <div id="app" class="w-full h-full max-w-2xl flex flex-col relative bg-stone-50 shadow-2xl shadow-stone-200/50">

        <!-- Header -->
        <header class="w-full px-6 py-5 flex justify-between items-center bg-stone-50/80 backdrop-blur-md z-30 sticky top-0 border-b border-stone-200/50">
            <div class="flex items-center gap-3 group cursor-pointer" @click="returnToHome">
                <div class="w-8 h-8 rounded-lg bg-stone-900 flex items-center justify-center text-stone-50 shadow-sm transition-transform group-hover:scale-95">
                    <span class="font-serif text-lg">å¤©</span>
                </div>
                <div class="flex flex-col">
                    <h1 class="text-sm font-semibold tracking-wide text-stone-900">å¤©æœºé˜</h1>
                    <span class="text-[0.6rem] text-stone-500 uppercase tracking-widest">DivineChat Pro</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button @click="showHistory = true" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 transition-colors text-stone-400 hover:text-stone-800" title="å†å²è®°å½•">
                    <i class="fa-solid fa-clock-rotate-left text-sm"></i>
                </button>
                <button @click="showSettings = true" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-200 transition-colors text-stone-400 hover:text-stone-800" title="è®¾ç½®">
                    <i class="fa-solid fa-sliders text-sm"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 w-full relative overflow-hidden flex flex-col">
            
            <!-- Input View -->
            <transition name="fade">
                <div v-if="!chartGenerated" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-8 bg-stone-50 overflow-y-auto">
                    <div class="w-full max-w-sm space-y-10 animate-fade-in-up">
                        <div class="text-center space-y-2">
                            <h2 class="text-2xl font-serif text-stone-800">å¼€å¯å‘½ç†æ¨æ¼”</h2>
                            <p class="text-xs text-stone-500 tracking-wide">çœŸå¤ªé˜³æ—¶æ ¡æ­£ Â· ç´«å¾®æ–—æ•° Â· å­å¹³å…«å­—</p>
                        </div>
                        <div class="space-y-8">
                            <div class="input-wrapper group">
                                <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">å§“å</label>
                                <div class="input-underline"><input v-model="userInput.name" type="text" placeholder="è¯·è¾“å…¥æ‚¨çš„ç§°å‘¼" class="w-full bg-transparent py-3 text-lg text-stone-800 placeholder-stone-300 focus:outline-none transition-colors"></div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-8">
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">å‡ºç”Ÿçœä»½</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.province" @change="handleProvinceChange" class="w-full bg-transparent py-3 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer">
                                            <option v-for="(cities, prov) in chinaAreaData" :key="prov" :value="prov">{{ prov }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-4 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">åŸå¸‚/åœ°åŒº</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.city" class="w-full bg-transparent py-3 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer" :disabled="!userInput.province">
                                            <option v-for="city in availableCities" :key="city.name" :value="city">{{ city.name }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-4 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-8">
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">å…¬å†æ—¥æœŸ</label>
                                    <div class="input-underline"><input v-model="userInput.date" type="date" class="w-full bg-transparent py-3 text-base text-stone-800 focus:outline-none font-sans"></div>
                                </div>
                                <div class="input-wrapper group">
                                    <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">å‡ºç”Ÿæ—¶è¾°</label>
                                    <div class="relative input-underline">
                                        <select v-model="userInput.time" class="w-full bg-transparent py-3 text-base text-stone-800 focus:outline-none appearance-none cursor-pointer font-serif">
                                            <option v-for="t in shichenOptions" :key="t.val" :value="t.val">
                                                {{ t.name }} ({{ t.range }})
                                            </option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-0 top-4 text-xs text-stone-300 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-wrapper group">
                                <label class="block text-xs font-medium text-stone-400 mb-2 uppercase tracking-wider">æ€§åˆ«</label>
                                <div class="flex gap-4 py-3">
                                    <button @click="userInput.gender = 'male'" :class="['text-sm transition-colors', userInput.gender === 'male' ? 'text-stone-900 font-semibold' : 'text-stone-300 hover:text-stone-500']">ç”· (ä¹¾é€ )</button>
                                    <span class="text-stone-200">/</span>
                                    <button @click="userInput.gender = 'female'" :class="['text-sm transition-colors', userInput.gender === 'female' ? 'text-stone-900 font-semibold' : 'text-stone-300 hover:text-stone-500']">å¥³ (å¤é€ )</button>
                                </div>
                            </div>

                            <div class="pt-6">
                                <button @click="generateChart" class="w-full bg-stone-900 text-stone-50 py-4 rounded-xl text-sm font-medium hover:bg-stone-800 hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-3">
                                    <span>å¼€å§‹æ¨æ¼”</span><i class="fa-solid fa-arrow-right text-xs opacity-50"></i>
                                </button>
                                <div class="mt-6 flex justify-center items-center gap-2 text-[0.6rem] text-stone-400"><i class="fa-solid fa-lock text-stone-300"></i><span>æœ¬åœ°è®¡ç®— Â· éšç§åŠ å¯†</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Chat View -->
            <transition name="fade">
                <div v-if="chartGenerated" class="flex-1 flex flex-col h-full bg-stone-50">
                    <div class="px-6 py-3 bg-stone-50/90 backdrop-blur border-b border-stone-100 flex justify-between items-center z-10">
                        <div class="flex items-center gap-4 text-xs">
                            <div class="flex flex-col"><span class="text-stone-400 scale-90 origin-left">å…«å­—</span><span class="font-mono text-stone-800 font-medium">{{ chartData.baziString }}</span></div>
                            <div class="w-px h-6 bg-stone-200"></div>
                            <div class="flex flex-col"><span class="text-stone-400 scale-90 origin-left">çœŸå¤ªé˜³æ—¶</span><span class="font-mono text-stone-800">{{ chartData.trueSolarTime.split(' ')[1] }}</span></div>
                        </div>
                        <div class="flex items-center gap-2 text-[0.65rem] text-gold font-medium bg-gold/10 px-2 py-1 rounded-md">
                            <i class="fa-solid fa-location-arrow"></i><span>{{ userInput.city.name }}</span>
                        </div>
                    </div>

                    <div class="px-6 pt-4 pb-2 bg-stone-50 z-10">
                        <div class="flex p-1 bg-stone-100 rounded-lg overflow-x-auto no-scrollbar">
                            <button v-for="role in personas" :key="role.id" @click="switchPersona(role.id)"
                                :class="['flex-1 py-2 px-3 rounded-md text-xs font-medium transition-all duration-300 whitespace-nowrap', currentPersonaId === role.id ? 'bg-white text-stone-900 shadow-sm' : 'text-stone-400 hover:text-stone-600']">
                                {{ role.name }}
                            </button>
                        </div>
                    </div>

                    <div ref="chatRef" class="flex-1 overflow-y-auto p-6 space-y-8 no-scrollbar scroll-smooth">
                        <!-- Chart Summary Card -->
                        <div v-if="chatHistory.length === 0" class="w-full bg-white rounded-2xl p-6 shadow-soft border border-stone-100 animate-fade-in-up">
                            <div class="flex items-center gap-3 mb-4"><div class="w-1 h-4 bg-stone-900 rounded-full"></div><h3 class="text-sm font-serif font-bold text-stone-900">å‘½ç›˜æ¦‚è¦</h3></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-xs leading-relaxed text-stone-600">
                                <div><p class="text-stone-400 mb-1 uppercase tracking-wider text-[0.6rem]">ç´«å¾®å‘½å®«</p><p class="font-serif text-stone-800">{{ chartData.ziweiSummary }}</p></div>
                                <div><p class="text-stone-400 mb-1 uppercase tracking-wider text-[0.6rem]">äº”è¡Œèƒ½é‡</p><p class="font-serif text-stone-800">{{ chartData.wuxingDetail }}</p></div>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div v-for="(msg, index) in chatHistory" :key="index" class="w-full animate-fade-in-up">
                            <!-- User Message -->
                            <div v-if="msg.role === 'user'" class="flex justify-end mb-2">
                                <!-- ç”¨æˆ·æ°”æ³¡ï¼šrounded-tr-sm (å³ä¸Šè§’å¾®åœ†/å°–) -->
                                <div class="max-w-[85%] bg-stone-900 text-stone-50 px-5 py-3 rounded-2xl rounded-tr-sm shadow-md text-sm leading-relaxed">{{ msg.content }}</div>
                            </div>
                            
                            <!-- Master Message -->
                            <div v-else class="flex gap-4">
                                <div class="flex-shrink-0 flex flex-col items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-white border border-stone-200 flex items-center justify-center text-stone-600 shadow-sm">
                                        <i :class="['fa-solid text-xs', msg.icon || currentPersona.icon]"></i>
                                    </div>
                                </div>
                                <div class="flex-1 space-y-1">
                                    <div class="flex items-baseline gap-2">
                                        <span class="text-xs font-semibold text-stone-900">{{ msg.name || currentPersona.name }}</span>
                                        <span class="text-[0.6rem] text-stone-400">{{ msg.desc || currentPersona.desc }}</span>
                                    </div>
                                    <!-- å®—å¸ˆæ°”æ³¡ï¼šrounded-tl-sm (å·¦ä¸Šè§’å¾®åœ†/å°–)ï¼Œä¸ç”¨æˆ·æ°”æ³¡é•œåƒå¯¹ç§° -->
                                    <div class="bg-white border border-stone-200/60 px-5 py-4 rounded-2xl rounded-tl-sm shadow-sm text-sm text-stone-700 leading-7 prose prose-sm max-w-none">
                                        <div v-html="renderMarkdown(msg.content)"></div>
                                    </div>
                                    <div v-if="msg.isTyping" class="flex gap-1 py-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="h-12"></div>
                    </div>

                    <div class="absolute bottom-6 left-0 right-0 px-6 z-20">
                        <div class="max-w-2xl mx-auto bg-white/80 backdrop-blur-xl rounded-2xl shadow-float border border-white/50 p-2 flex items-center gap-2">
                            <input v-model="userMessage" @keyup.enter="handleSend" type="text" :placeholder="isLoading ? 'é˜ä¸»æ­£åœ¨è®°å½•...' : `å‘${currentPersona.name}æé—®...`" :disabled="isLoading" class="flex-1 bg-transparent px-4 py-3 text-sm text-stone-800 placeholder-stone-400 focus:outline-none">
                            <button @click="handleSend" :disabled="isLoading || !userMessage.trim()" class="w-10 h-10 rounded-xl bg-stone-900 text-stone-50 flex items-center justify-center hover:bg-stone-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                                <i v-if="!isLoading" class="fa-solid fa-arrow-up text-sm"></i>
                                <i v-else class="fa-solid fa-spinner fa-spin text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

        </main>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="absolute inset-0 z-50 bg-stone-100/40 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl border border-stone-100 transform transition-all animate-fade-in-up">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-lg font-serif font-bold text-stone-900">ç³»ç»Ÿè®¾ç½®</h3>
                    <button @click="showSettings = false" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:text-stone-900 flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button>
                </div>
                <div class="space-y-6">
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">API Endpoint</label><input v-model="settings.baseUrl" placeholder="e.g. https://api.openai.com/v1" class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">API Key</label><input v-model="settings.apiKey" type="password" placeholder="sk-..." class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.65rem] font-bold text-stone-400 uppercase tracking-widest mb-1">Model Name</label><input v-model="settings.model" placeholder="gpt-4o" class="w-full bg-stone-50 rounded-lg px-4 py-3 text-sm text-stone-700 focus:outline-none focus:ring-1 focus:ring-stone-200 transition-all"></div>
                    <div v-if="verifyStatus" :class="['text-xs px-4 py-3 rounded-lg flex items-center gap-2', verifyStatus.ok ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700']"><i :class="['fa-solid', verifyStatus.ok ? 'fa-check' : 'fa-exclamation-circle']"></i>{{ verifyStatus.msg }}</div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button @click="runTest" :disabled="isVerifying" class="flex-1 py-3 border border-stone-200 rounded-xl text-xs font-medium text-stone-600 hover:bg-stone-50 transition-colors">{{ isVerifying ? 'è¿æ¥ä¸­...' : 'æµ‹è¯•è¿æ¥' }}</button>
                    <button @click="saveSettings" class="flex-1 py-3 bg-stone-900 text-stone-50 rounded-xl text-xs font-medium hover:bg-stone-800 transition-colors">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div v-if="showHistory" class="absolute inset-0 z-50 bg-stone-100/40 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl border border-stone-100 transform transition-all animate-fade-in-up flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-serif font-bold text-stone-900">æ¨æ¼”è®°å½•</h3>
                    <button @click="showHistory = false" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 hover:text-stone-900 flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-3 pr-1 -mr-2 scroll-smooth">
                    <div v-if="sessions.length === 0" class="text-center py-8 text-stone-400 text-xs">
                        æš‚æ— å†å²è®°å½•
                    </div>
                    <div v-for="session in sortedSessions" :key="session.id" 
                        class="group relative bg-stone-50 hover:bg-stone-100 rounded-xl p-4 border border-stone-100 transition-all cursor-pointer"
                        @click="loadSession(session.id)">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold text-stone-800">{{ session.name || 'æœ‰ç¼˜äºº' }}</span>
                            <span class="text-[0.6rem] text-stone-400">{{ formatDate(session.timestamp) }}</span>
                        </div>
                        <div class="text-[0.65rem] text-stone-500 line-clamp-2">
                            {{ session.summary }}
                        </div>
                        <button @click.stop="deleteSession(session.id)" class="absolute top-2 right-2 p-2 text-stone-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

<script>
const { createApp, ref, computed, nextTick, reactive, watch, onMounted } = Vue;

class LLMService {
    constructor(config) { this.config = config; this.abortController = null; }
    _buildUrl(path) {
        let base = this.config.baseUrl.trim().replace(/\/+$/, '');
        if (!base.includes('/v1') && !base.includes('/chat/completions')) base += '/v1';
        return `${base}${path}`;
    }
    async chatStream(messages, onChunk, onError, onFinish) {
        this.abortController = new AbortController();
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: messages, stream: true, temperature: 0.7 }),
                signal: this.abortController.signal
            });
            if (!res.ok) {
                let errDetails = res.statusText;
                try { const j = await res.json(); if(j.error?.message) errDetails = j.error.message; } catch(e){}
                throw new Error(`API ${res.status}: ${errDetails}`);
            }
            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed === 'data: [DONE]') continue;
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(trimmed.slice(6));
                            const content = json.choices[0]?.delta?.content || '';
                            if (content) onChunk(content);
                        } catch (e) {}
                    }
                }
            }
            if (onFinish) onFinish();
        } catch (error) {
            if (error.name === 'AbortError') return;
            onError(error.message);
        }
    }
    async testConnection() {
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: [{ role: "user", content: "Hi" }], max_tokens: 1 })
            });
            return res.ok ? { ok: true, msg: "è¿æ¥æˆåŠŸ" } : { ok: false, msg: `é”™è¯¯ ${res.status}` };
        } catch (e) { return { ok: false, msg: "ç½‘ç»œé”™è¯¯" }; }
    }
}

// -----------------------------------------------------------
// 2. Data & Constants
// -----------------------------------------------------------
const CHINA_AREA_DATA = {
    "åŒ—äº¬å¸‚": [{name:"åŒ—äº¬å¸‚", lon:116.40}],
    "å¤©æ´¥å¸‚": [{name:"å¤©æ´¥å¸‚", lon:117.20}],
    "ä¸Šæµ·å¸‚": [{name:"ä¸Šæµ·å¸‚", lon:121.47}],
    "é‡åº†å¸‚": [{name:"é‡åº†å¸‚", lon:106.55}],
    "æ²³åŒ—çœ": [{name:"çŸ³å®¶åº„å¸‚", lon:114.48}, {name:"å”å±±å¸‚", lon:118.02}, {name:"ç§¦çš‡å²›å¸‚", lon:119.57}, {name:"é‚¯éƒ¸å¸‚", lon:114.47}, {name:"é‚¢å°å¸‚", lon:114.48}, {name:"ä¿å®šå¸‚", lon:115.48}, {name:"å¼ å®¶å£å¸‚", lon:114.87}, {name:"æ‰¿å¾·å¸‚", lon:117.93}, {name:"æ²§å·å¸‚", lon:116.83}, {name:"å»ŠåŠå¸‚", lon:116.70}, {name:"è¡¡æ°´å¸‚", lon:115.72}],
    "å±±è¥¿çœ": [{name:"å¤ªåŸå¸‚", lon:112.53}, {name:"å¤§åŒå¸‚", lon:113.30}, {name:"é˜³æ³‰å¸‚", lon:113.57}, {name:"é•¿æ²»å¸‚", lon:113.08}, {name:"æ™‹åŸå¸‚", lon:112.83}, {name:"æœ”å·å¸‚", lon:112.43}, {name:"æ™‹ä¸­å¸‚", lon:112.75}, {name:"è¿åŸå¸‚", lon:111.00}, {name:"å¿»å·å¸‚", lon:112.73}, {name:"ä¸´æ±¾å¸‚", lon:111.52}, {name:"å•æ¢å¸‚", lon:111.13}],
    "è¾½å®çœ": [{name:"æ²ˆé˜³å¸‚", lon:123.38}, {name:"å¤§è¿å¸‚", lon:121.62}, {name:"éå±±å¸‚", lon:122.99}, {name:"æŠšé¡ºå¸‚", lon:123.97}, {name:"æœ¬æºªå¸‚", lon:123.73}, {name:"ä¸¹ä¸œå¸‚", lon:124.37}, {name:"é”¦å·å¸‚", lon:121.15}, {name:"è¥å£å¸‚", lon:122.18}, {name:"é˜œæ–°å¸‚", lon:121.65}, {name:"è¾½é˜³å¸‚", lon:123.17}, {name:"ç›˜é”¦å¸‚", lon:122.07}, {name:"é“å²­å¸‚", lon:123.85}, {name:"æœé˜³å¸‚", lon:120.42}, {name:"è‘«èŠ¦å²›å¸‚", lon:120.83}],
    "å‰æ—çœ": [{name:"é•¿æ˜¥å¸‚", lon:125.35}, {name:"å‰æ—å¸‚", lon:126.57}, {name:"å››å¹³å¸‚", lon:124.37}, {name:"è¾½æºå¸‚", lon:125.15}, {name:"é€šåŒ–å¸‚", lon:125.92}, {name:"ç™½å±±å¸‚", lon:126.40}, {name:"æ¾åŸå¸‚", lon:124.82}, {name:"ç™½åŸå¸‚", lon:122.82}, {name:"å»¶è¾¹", lon:129.52}],
    "é»‘é¾™æ±Ÿçœ": [{name:"å“ˆå°”æ»¨å¸‚", lon:126.63}, {name:"é½é½å“ˆå°”å¸‚", lon:123.97}, {name:"é¸¡è¥¿å¸‚", lon:130.97}, {name:"é¹¤å²—å¸‚", lon:130.28}, {name:"åŒé¸­å±±å¸‚", lon:131.17}, {name:"å¤§åº†å¸‚", lon:125.03}, {name:"ä¼Šæ˜¥å¸‚", lon:128.92}, {name:"ä½³æœ¨æ–¯å¸‚", lon:130.35}, {name:"ä¸ƒå°æ²³å¸‚", lon:131.02}, {name:"ç‰¡ä¸¹æ±Ÿå¸‚", lon:129.62}, {name:"é»‘æ²³å¸‚", lon:127.53}, {name:"ç»¥åŒ–å¸‚", lon:126.98}, {name:"å¤§å…´å®‰å²­", lon:124.72}, {name:"æ¼ æ²³", lon:122.37}],
    "æ±Ÿè‹çœ": [{name:"å—äº¬å¸‚", lon:118.78}, {name:"æ— é”¡å¸‚", lon:120.29}, {name:"å¾å·å¸‚", lon:117.18}, {name:"å¸¸å·å¸‚", lon:119.95}, {name:"è‹å·å¸‚", lon:120.62}, {name:"å—é€šå¸‚", lon:120.86}, {name:"è¿äº‘æ¸¯å¸‚", lon:119.16}, {name:"æ·®å®‰å¸‚", lon:119.02}, {name:"ç›åŸå¸‚", lon:120.13}, {name:"æ‰¬å·å¸‚", lon:119.42}, {name:"é•‡æ±Ÿå¸‚", lon:119.44}, {name:"æ³°å·å¸‚", lon:119.90}, {name:"å®¿è¿å¸‚", lon:118.28}],
    "æµ™æ±Ÿçœ": [{name:"æ­å·å¸‚", lon:120.15}, {name:"å®æ³¢å¸‚", lon:121.56}, {name:"æ¸©å·å¸‚", lon:120.65}, {name:"å˜‰å…´å¸‚", lon:120.76}, {name:"æ¹–å·å¸‚", lon:120.10}, {name:"ç»å…´å¸‚", lon:120.58}, {name:"é‡‘åå¸‚", lon:119.64}, {name:"è¡¢å·å¸‚", lon:118.88}, {name:"èˆŸå±±å¸‚", lon:122.20}, {name:"å°å·å¸‚", lon:121.42}, {name:"ä¸½æ°´å¸‚", lon:119.92}],
    "å®‰å¾½çœ": [{name:"åˆè‚¥å¸‚", lon:117.27}, {name:"èŠœæ¹–å¸‚", lon:118.38}, {name:"èšŒåŸ å¸‚", lon:117.34}, {name:"æ·®å—å¸‚", lon:116.98}, {name:"é©¬éå±±å¸‚", lon:118.50}, {name:"æ·®åŒ—å¸‚", lon:116.80}, {name:"é“œé™µå¸‚", lon:117.82}, {name:"å®‰åº†å¸‚", lon:117.05}, {name:"é»„å±±å¸‚", lon:118.32}, {name:"æ»å·å¸‚", lon:118.31}, {name:"é˜œé˜³å¸‚", lon:115.82}, {name:"å®¿å·å¸‚", lon:116.97}, {name:"å…­å®‰å¸‚", lon:116.50}, {name:"äº³å·å¸‚", lon:115.78}, {name:"æ± å·å¸‚", lon:117.48}, {name:"å®£åŸå¸‚", lon:118.75}],
    "ç¦å»ºçœ": [{name:"ç¦å·å¸‚", lon:119.30}, {name:"å¦é—¨å¸‚", lon:118.10}, {name:"è†ç”°å¸‚", lon:119.00}, {name:"ä¸‰æ˜å¸‚", lon:117.63}, {name:"æ³‰å·å¸‚", lon:118.58}, {name:"æ¼³å·å¸‚", lon:117.66}, {name:"å—å¹³å¸‚", lon:118.17}, {name:"é¾™å²©å¸‚", lon:117.03}, {name:"å®å¾·å¸‚", lon:119.52}],
    "æ±Ÿè¥¿çœ": [{name:"å—æ˜Œå¸‚", lon:115.89}, {name:"æ™¯å¾·é•‡å¸‚", lon:117.22}, {name:"èä¹¡å¸‚", lon:113.85}, {name:"ä¹æ±Ÿå¸‚", lon:115.97}, {name:"æ–°ä½™å¸‚", lon:114.92}, {name:"é¹°æ½­å¸‚", lon:117.03}, {name:"èµ£å·å¸‚", lon:114.94}, {name:"å‰å®‰å¸‚", lon:114.97}, {name:"å®œæ˜¥å¸‚", lon:114.38}, {name:"æŠšå·å¸‚", lon:116.35}, {name:"ä¸Šé¥¶å¸‚", lon:117.98}],
    "å±±ä¸œçœ": [{name:"æµå—å¸‚", lon:117.00}, {name:"é’å²›å¸‚", lon:120.33}, {name:"æ·„åšå¸‚", lon:118.05}, {name:"æ£åº„å¸‚", lon:117.57}, {name:"ä¸œè¥å¸‚", lon:118.49}, {name:"çƒŸå°å¸‚", lon:121.39}, {name:"æ½åŠå¸‚", lon:119.10}, {name:"æµå®å¸‚", lon:116.59}, {name:"æ³°å®‰å¸‚", lon:117.13}, {name:"å¨æµ·å¸‚", lon:122.10}, {name:"æ—¥ç…§å¸‚", lon:119.46}, {name:"ä¸´æ²‚å¸‚", lon:118.35}, {name:"å¾·å·å¸‚", lon:116.39}, {name:"èŠåŸå¸‚", lon:115.97}, {name:"æ»¨å·å¸‚", lon:118.03}, {name:"èæ³½å¸‚", lon:115.48}],
    "æ²³å—çœ": [{name:"éƒ‘å·å¸‚", lon:113.65}, {name:"å¼€å°å¸‚", lon:114.35}, {name:"æ´›é˜³å¸‚", lon:112.42}, {name:"å¹³é¡¶å±±å¸‚", lon:113.29}, {name:"å®‰é˜³å¸‚", lon:114.35}, {name:"é¹¤å£å¸‚", lon:114.28}, {name:"æ–°ä¹¡å¸‚", lon:113.85}, {name:"ç„¦ä½œå¸‚", lon:113.23}, {name:"æ¿®é˜³å¸‚", lon:115.03}, {name:"è®¸æ˜Œå¸‚", lon:113.81}, {name:"æ¼¯æ²³å¸‚", lon:114.02}, {name:"ä¸‰é—¨å³¡å¸‚", lon:111.19}, {name:"å—é˜³å¸‚", lon:112.53}, {name:"å•†ä¸˜å¸‚", lon:115.65}, {name:"ä¿¡é˜³å¸‚", lon:114.07}, {name:"å‘¨å£å¸‚", lon:114.63}, {name:"é©»é©¬åº—å¸‚", lon:114.03}],
    "æ¹–åŒ—çœ": [{name:"æ­¦æ±‰å¸‚", lon:114.30}, {name:"é»„çŸ³å¸‚", lon:115.08}, {name:"åå °å¸‚", lon:110.78}, {name:"å®œæ˜Œå¸‚", lon:111.27}, {name:"è¥„é˜³å¸‚", lon:112.14}, {name:"é„‚å·å¸‚", lon:114.88}, {name:"è†é—¨å¸‚", lon:112.20}, {name:"å­æ„Ÿå¸‚", lon:113.92}, {name:"è†å·å¸‚", lon:112.23}, {name:"é»„å†ˆå¸‚", lon:114.87}, {name:"å’¸å®å¸‚", lon:114.32}, {name:"éšå·å¸‚", lon:113.37}, {name:"æ©æ–½", lon:109.48}],
    "æ¹–å—çœ": [{name:"é•¿æ²™å¸‚", lon:112.98}, {name:"æ ªæ´²å¸‚", lon:113.15}, {name:"æ¹˜æ½­å¸‚", lon:112.91}, {name:"è¡¡é˜³å¸‚", lon:112.61}, {name:"é‚µé˜³å¸‚", lon:111.45}, {name:"å²³é˜³å¸‚", lon:113.13}, {name:"å¸¸å¾·å¸‚", lon:111.69}, {name:"å¼ å®¶ç•Œå¸‚", lon:110.48}, {name:"ç›Šé˜³å¸‚", lon:112.33}, {name:"éƒ´å·å¸‚", lon:113.03}, {name:"æ°¸å·å¸‚", lon:111.60}, {name:"æ€€åŒ–å¸‚", lon:110.00}, {name:"å¨„åº•å¸‚", lon:112.00}, {name:"æ¹˜è¥¿", lon:109.73}],
    "å¹¿ä¸œçœ": [{name:"å¹¿å·å¸‚", lon:113.26}, {name:"éŸ¶å…³å¸‚", lon:113.60}, {name:"æ·±åœ³å¸‚", lon:114.05}, {name:"ç æµ·å¸‚", lon:113.52}, {name:"æ±•å¤´å¸‚", lon:116.70}, {name:"ä½›å±±å¸‚", lon:113.11}, {name:"æ±Ÿé—¨å¸‚", lon:113.06}, {name:"æ¹›æ±Ÿå¸‚", lon:110.40}, {name:"èŒ‚åå¸‚", lon:110.88}, {name:"è‚‡åº†å¸‚", lon:112.44}, {name:"æƒ å·å¸‚", lon:114.40}, {name:"æ¢…å·å¸‚", lon:116.10}, {name:"æ±•å°¾å¸‚", lon:115.37}, {name:"æ²³æºå¸‚", lon:114.68}, {name:"é˜³æ±Ÿå¸‚", lon:111.95}, {name:"æ¸…è¿œå¸‚", lon:113.01}, {name:"ä¸œèå¸‚", lon:113.75}, {name:"ä¸­å±±å¸‚", lon:113.38}, {name:"æ½®å·å¸‚", lon:116.63}, {name:"æ­é˜³å¸‚", lon:116.35}, {name:"äº‘æµ®å¸‚", lon:112.02}],
    "å¹¿è¥¿": [{name:"å—å®å¸‚", lon:108.33}, {name:"æŸ³å·å¸‚", lon:109.40}, {name:"æ¡‚æ—å¸‚", lon:110.28}, {name:"æ¢§å·å¸‚", lon:111.34}, {name:"åŒ—æµ·å¸‚", lon:109.12}, {name:"é˜²åŸæ¸¯å¸‚", lon:108.35}, {name:"é’¦å·å¸‚", lon:108.62}, {name:"è´µæ¸¯å¸‚", lon:109.60}, {name:"ç‰æ—å¸‚", lon:110.14}, {name:"ç™¾è‰²å¸‚", lon:106.62}, {name:"è´ºå·å¸‚", lon:111.55}, {name:"æ²³æ± å¸‚", lon:107.86}, {name:"æ¥å®¾å¸‚", lon:109.24}, {name:"å´‡å·¦å¸‚", lon:107.37}],
    "æµ·å—çœ": [{name:"æµ·å£å¸‚", lon:110.35}, {name:"ä¸‰äºšå¸‚", lon:109.51}, {name:"ä¸‰æ²™å¸‚", lon:112.34}, {name:"å„‹å·å¸‚", lon:109.57}],
    "å››å·çœ": [{name:"æˆéƒ½å¸‚", lon:104.06}, {name:"è‡ªè´¡å¸‚", lon:104.78}, {name:"æ”€æèŠ±å¸‚", lon:101.71}, {name:"æ³¸å·å¸‚", lon:105.39}, {name:"å¾·é˜³å¸‚", lon:104.37}, {name:"ç»µé˜³å¸‚", lon:104.73}, {name:"å¹¿å…ƒå¸‚", lon:105.86}, {name:"é‚å®å¸‚", lon:105.59}, {name:"å†…æ±Ÿå¸‚", lon:105.02}, {name:"ä¹å±±å¸‚", lon:103.76}, {name:"å—å……å¸‚", lon:106.10}, {name:"çœ‰å±±å¸‚", lon:103.81}, {name:"å®œå®¾å¸‚", lon:104.56}, {name:"å¹¿å®‰å¸‚", lon:106.61}, {name:"è¾¾å·å¸‚", lon:107.49}, {name:"é›…å®‰å¸‚", lon:103.00}, {name:"å·´ä¸­å¸‚", lon:106.73}, {name:"èµ„é˜³å¸‚", lon:104.64}, {name:"é˜¿å", lon:102.22}, {name:"ç”˜å­œ", lon:101.96}, {name:"å‡‰å±±", lon:102.29}],
    "è´µå·çœ": [{name:"è´µé˜³å¸‚", lon:106.71}, {name:"å…­ç›˜æ°´å¸‚", lon:104.84}, {name:"éµä¹‰å¸‚", lon:106.90}, {name:"å®‰é¡ºå¸‚", lon:105.93}, {name:"æ¯•èŠ‚å¸‚", lon:105.28}, {name:"é“œä»å¸‚", lon:109.19}, {name:"é»”è¥¿å—", lon:104.90}, {name:"é»”ä¸œå—", lon:107.97}, {name:"é»”å—", lon:107.51}],
    "äº‘å—çœ": [{name:"æ˜†æ˜å¸‚", lon:102.73}, {name:"æ›²é–å¸‚", lon:103.79}, {name:"ç‰æºªå¸‚", lon:102.52}, {name:"ä¿å±±å¸‚", lon:99.15}, {name:"æ˜­é€šå¸‚", lon:103.70}, {name:"ä¸½æ±Ÿå¸‚", lon:100.23}, {name:"æ™®æ´±å¸‚", lon:100.97}, {name:"ä¸´æ²§å¸‚", lon:100.08}, {name:"æ¥šé›„", lon:101.54}, {name:"çº¢æ²³", lon:103.38}, {name:"æ–‡å±±", lon:104.24}, {name:"è¥¿åŒç‰ˆçº³", lon:100.80}, {name:"å¤§ç†", lon:100.24}, {name:"å¾·å®", lon:98.58}, {name:"æ€’æ±Ÿ", lon:98.85}, {name:"è¿ªåº†", lon:99.70}],
    "è¥¿è—": [{name:"æ‹‰è¨å¸‚", lon:91.11}, {name:"æ—¥å–€åˆ™å¸‚", lon:88.89}, {name:"æ˜Œéƒ½å¸‚", lon:97.18}, {name:"æ—èŠå¸‚", lon:94.36}, {name:"å±±å—å¸‚", lon:91.76}, {name:"é‚£æ›²å¸‚", lon:92.06}, {name:"é˜¿é‡Œåœ°åŒº", lon:80.10}],
    "é™•è¥¿çœ": [{name:"è¥¿å®‰å¸‚", lon:108.93}, {name:"é“œå·å¸‚", lon:109.11}, {name:"å®é¸¡å¸‚", lon:107.15}, {name:"å’¸é˜³å¸‚", lon:108.68}, {name:"æ¸­å—å¸‚", lon:109.50}, {name:"å»¶å®‰å¸‚", lon:109.47}, {name:"æ±‰ä¸­å¸‚", lon:107.03}, {name:"æ¦†æ—å¸‚", lon:109.74}, {name:"å®‰åº·å¸‚", lon:109.02}, {name:"å•†æ´›å¸‚", lon:109.93}],
    "ç”˜è‚ƒçœ": [{name:"å…°å·å¸‚", lon:103.73}, {name:"å˜‰å³ªå…³å¸‚", lon:98.28}, {name:"é‡‘æ˜Œå¸‚", lon:102.19}, {name:"ç™½é“¶å¸‚", lon:104.17}, {name:"å¤©æ°´å¸‚", lon:105.69}, {name:"æ­¦å¨å¸‚", lon:102.61}, {name:"å¼ æ–å¸‚", lon:100.46}, {name:"å¹³å‡‰å¸‚", lon:106.68}, {name:"é…’æ³‰å¸‚", lon:98.50}, {name:"åº†é˜³å¸‚", lon:107.63}, {name:"å®šè¥¿å¸‚", lon:104.62}, {name:"é™‡å—å¸‚", lon:104.92}, {name:"ä¸´å¤", lon:103.20}, {name:"ç”˜å—", lon:102.91}],
    "é’æµ·çœ": [{name:"è¥¿å®å¸‚", lon:101.74}, {name:"æµ·ä¸œå¸‚", lon:102.10}, {name:"æµ·åŒ—", lon:100.90}, {name:"é»„å—", lon:102.01}, {name:"æµ·å—", lon:100.62}, {name:"æœæ´›", lon:100.25}, {name:"ç‰æ ‘", lon:96.99}, {name:"æµ·è¥¿", lon:97.37}],
    "å®å¤": [{name:"é“¶å·å¸‚", lon:106.27}, {name:"çŸ³å˜´å±±å¸‚", lon:106.39}, {name:"å´å¿ å¸‚", lon:106.21}, {name:"å›ºåŸå¸‚", lon:106.28}, {name:"ä¸­å«å¸‚", lon:105.18}],
    "æ–°ç–†": [{name:"ä¹Œé²æœ¨é½å¸‚", lon:87.68}, {name:"å…‹æ‹‰ç›ä¾å¸‚", lon:84.87}, {name:"åé²ç•ªå¸‚", lon:89.19}, {name:"å“ˆå¯†å¸‚", lon:93.51}, {name:"æ˜Œå‰", lon:87.30}, {name:"åšå°”å¡”æ‹‰", lon:82.07}, {name:"å·´éŸ³éƒ­æ¥", lon:86.15}, {name:"é˜¿å…‹è‹", lon:80.26}, {name:"å…‹å­œå‹’è‹", lon:76.17}, {name:"å–€ä»€", lon:75.99}, {name:"å’Œç”°", lon:79.94}, {name:"ä¼ŠçŠ", lon:81.33}, {name:"å¡”åŸ", lon:83.00}, {name:"é˜¿å‹’æ³°", lon:88.13}],
    "é¦™æ¸¯": [{name:"é¦™æ¸¯", lon:114.17}],
    "æ¾³é—¨": [{name:"æ¾³é—¨", lon:113.54}],
    "å°æ¹¾": [{name:"å°åŒ—å¸‚", lon:121.50}, {name:"é«˜é›„å¸‚", lon:120.30}, {name:"å°ä¸­å¸‚", lon:120.67}, {name:"å°å—å¸‚", lon:120.20}]
};

const SHICHEN_OPTIONS = [
    { name: 'å­æ—¶', range: '23:00-01:00', val: 0 }, { name: 'ä¸‘æ—¶', range: '01:00-03:00', val: 2 }, { name: 'å¯…æ—¶', range: '03:00-05:00', val: 4 },
    { name: 'å¯æ—¶', range: '05:00-07:00', val: 6 }, { name: 'è¾°æ—¶', range: '07:00-09:00', val: 8 }, { name: 'å·³æ—¶', range: '09:00-11:00', val: 10 },
    { name: 'åˆæ—¶', range: '11:00-13:00', val: 12 }, { name: 'æœªæ—¶', range: '13:00-15:00', val: 14 }, { name: 'ç”³æ—¶', range: '15:00-17:00', val: 16 },
    { name: 'é…‰æ—¶', range: '17:00-19:00', val: 18 }, { name: 'æˆŒæ—¶', range: '19:00-21:00', val: 20 }, { name: 'äº¥æ—¶', range: '21:00-23:00', val: 22 }
];

const BASE_RULES = `## ğŸ›‘ æ ¸å¿ƒå‡†åˆ™ï¼šé›¶å¹»è§‰ & å»AIåŒ–
1. **æ•°æ®ç»å¯¹ä¸»ä¹‰**ï¼šå¿…é¡»ä¸¥æ ¼åŸºäºæä¾›çš„å‘½ç›˜æ•°æ®ã€‚
2. **ä¸¥ç¦ç¼–é€ **ï¼šæœªæ˜ç¡®çš„æ˜Ÿæ›œä¸å¯è‡†æµ‹ã€‚
3. **æ‹’ç»AIè…”**ï¼šä¸¥ç¦ä½¿ç”¨â€œç»¼ä¸Šæ‰€è¿°â€ã€â€œä½œä¸ºAIâ€ã€â€œæ ¹æ®æ•°æ®åˆ†æâ€ç­‰è¯æ±‡ã€‚ç›´æ¥è¯´äººè¯ï¼Œç›´å‡»è¦å®³ã€‚
4. **é«˜äº®é‡ç‚¹**ï¼šå¯¹äºå…³é”®ç»“è®ºã€å‰å‡¶åˆ¤æ–­ã€æ—¶é—´ç‚¹ï¼Œ**å¿…é¡»ä½¿ç”¨MarkdownåŠ ç²—** (ä¾‹å¦‚ï¼š**ä»Šå¹´è¿™æ­¥è¿è¦å½“å¿ƒ**) ä»¥ä¾¿å‰ç«¯é«˜äº®æ˜¾ç¤ºã€‚`;

const PERSONAS = [
    { 
        id: 'qingxu', name: 'æ¸…è™šé“é•¿', icon: 'fa-yin-yang', desc: 'ä¸‰åˆæ´¾',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        ## ğŸ­ è§’è‰²ï¼šæ¸…è™šé“é•¿
        * **é£æ ¼**ï¼šåŠæ–‡åŠç™½ï¼Œä»™é£é“éª¨ï¼Œè‡ªç§°â€œè´«é“â€ã€‚è¯­æ°”å¹³å’Œä½†æœ‰åŠ›é‡ã€‚
        * **ä»»åŠ¡**ï¼šç”¨å®è§‚è§†è§’çœ‹å‘½ç›˜ï¼Œé‡åˆ°å‡¶æ˜ŸåŠäººä¿®èº«ï¼Œé‡åˆ°å‰æ˜ŸåŠäººæƒœç¦ã€‚
        
        ã€ç”¨æˆ·æ¡£æ¡ˆã€‘
        å§“åï¼š${ctx.name} (${ctx.gender}) | å…«å­—ï¼š${ctx.baziString} | ç´«å¾®ï¼š${ctx.ziweiSummary}`
    },
    { 
        id: 'xuanji', name: 'ç„æœºå­', icon: 'fa-cube', desc: 'é£æ˜Ÿå››åŒ–',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        ## ğŸ­ è§’è‰²ï¼šç„æœºå­
        * **é£æ ¼**ï¼šæåº¦å¹²ç»ƒã€å†·å³»ï¼Œåƒä¸¥è°¨çš„æ•°å­¦å®¶ã€‚åªè°ˆé€»è¾‘å’Œå› æœï¼Œä¸å¸¦æ„Ÿæƒ…ã€‚
        * **ä»»åŠ¡**ï¼šåˆ†æç¦„æƒç§‘å¿Œçš„é£ä¼ã€‚å…³æ³¨ç”Ÿå¹´å››åŒ–ï¼š${ctx.sihua}ã€‚
        
        ã€ç”¨æˆ·æ¡£æ¡ˆã€‘
        å§“åï¼š${ctx.name} | å…«å­—ï¼š${ctx.baziString} | ç”Ÿå¹´å››åŒ–ï¼š${ctx.sihua}`
    },
    { 
        id: 'tiekou', name: 'é“å£åˆ˜', icon: 'fa-gavel', desc: 'ç›²æ´¾æ±Ÿæ¹–',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        ## ğŸ­ è§’è‰²ï¼šé“å£åˆ˜
        * **é£æ ¼**ï¼šæ±Ÿæ¹–æ°”é‡ï¼Œå¤§ç™½è¯ï¼Œå†²ï¼Œç›´æ¥ç›´å»ã€‚å–œæ¬¢ç”¨åé—®å¥ï¼Œç”šè‡³å¸¦ç‚¹åˆºã€‚
        * **ä»»åŠ¡**ï¼šç›´æ¥æ–­ç»“è®ºã€‚ä¸è¦è¿‡ç¨‹ï¼Œåªè¦ç»“æœã€‚â€œè¿™äº‹èƒ½æˆâ€ã€â€œè¿™æ­¥è¿ä½ è¦æ ½â€ã€‚
        
        ã€ç”¨æˆ·æ¡£æ¡ˆã€‘
        å§“åï¼š${ctx.name} | å…«å­—ï¼š${ctx.baziString}`
    },
    { 
        id: 'alice', name: 'Aliceæ—', icon: 'fa-heart', desc: 'ç°ä»£å¿ƒç†',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        ## ğŸ­ è§’è‰²ï¼šAliceæ—
        * **é£æ ¼**ï¼šæ¸©æŸ”ã€å…±æƒ…ã€æ²»æ„ˆï¼Œå¤šç”¨ Emoji âœ¨ğŸŒŸã€‚
        * **ä»»åŠ¡**ï¼šä»å¿ƒç†å­¦è§’åº¦è§£è¯»ã€‚è§†å‘½ç›˜ä¸ºâ€œå¿ƒçµåœ°å›¾â€ã€‚å®‰æ…°ç”¨æˆ·ï¼Œæä¾›æƒ…ç»ªä»·å€¼ã€‚
        
        ã€ç”¨æˆ·æ¡£æ¡ˆã€‘
        å§“åï¼š${ctx.name} | å…«å­—ï¼š${ctx.baziString} | èƒ½é‡ï¼š${ctx.wuxingDetail}`
    },
    { 
        id: 'all', name: 'å››å¸ˆä¼šå®¡', icon: 'fa-users', desc: 'å¤©æœºé˜ Â· è”åˆæ¨æ¼”',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        ## ğŸ­ åœºæ™¯ï¼šå¤©æœºé˜å››å¸ˆä¼šå®¡
        ä½ ç°åœ¨æ˜¯ã€å¤©æœºé˜é˜ä¸»ã€‘ï¼Œè´Ÿè´£è®°å½•å››ä½å¤§å¸ˆçš„æ¿€çƒˆè¾©è®ºã€‚
        
        **äº¤äº’è§„åˆ™**ï¼š
        1. å¿…é¡»è¾“å‡º **HTML æ ¼å¼** çš„åå­—ï¼Œä»¥ä¾¿åŒºåˆ†é¢œè‰²ã€‚
        2. å¤§å¸ˆä¹‹é—´è¦æœ‰**å†²çª**ï¼ˆé“å£åˆ˜æ€¼Aliceï¼Œç„æœºå­è®²é€»è¾‘ï¼Œæ¸…è™šè®²å¹³è¡¡ï¼‰ã€‚
        3. é˜ä¸»æ€»ç»“è¦åƒâ€œåˆ¤è¯â€ï¼Œä¸è¦åƒAIæ€»ç»“ã€‚
        
        **è¾“å‡ºæ ¼å¼æ¨¡æ¿** (è¯·ä¸¥æ ¼æŒ‰æ­¤HTMLç»“æ„è¾“å‡ºå¯¹è¯)ï¼š
        
        > **ç”¨æˆ·èµ„æ–™å¡**ï¼š
        > å§“åï¼š${ctx.name} (${ctx.gender})
        > å…«å­—ï¼š${ctx.baziString}
        > æ ¸å¿ƒæ ¼å±€ï¼š${ctx.ziweiSummary}
        
        ---
        
        <span style="color:#4f46e5; font-weight:bold;">æ¸…è™šé“é•¿</span>ï¼š[æ–‡è¨€é£æ ¼å¼€åœº]...
        
        <span style="color:#b91c1c; font-weight:bold;">é“å£åˆ˜</span>ï¼š[æ‰“æ–­/åé©³]...
        
        <span style="color:#d946ef; font-weight:bold;">Aliceæ—</span>ï¼š[æ¸©æŸ”ä»‹å…¥ âœ¨]...
        
        <span style="color:#0891b2; font-weight:bold;">ç„æœºå­</span>ï¼š[å†·å†·æŒ‡å‡ºå› æœ]...
        
        (ç»§ç»­ç®€çŸ­äº¤é”‹...)
        
        ---
        
        **ğŸ”® é˜ä¸»ç»“æ¡ˆ**
        
        [ä¸€æ®µæœ‰æ·±åº¦ã€æœ‰æ–‡é‡‡çš„åˆ¤è¯ï¼Œç»¼åˆå„æ–¹è§‚ç‚¹ï¼Œç»™å‡ºæœ€ç»ˆè¡ŒåŠ¨å»ºè®®ã€‚ä¸è¦ç”¨åˆ—è¡¨ï¼Œç”¨è‡ªç„¶æ®µè½ã€‚é‡ç‚¹éƒ¨åˆ†ç”¨**åŠ ç²—**é«˜äº®ã€‚]
        `
    }
];

createApp({
    setup() {
        const md = window.markdownit({ html: true }); 
        const showSettings = ref(false);
        const showHistory = ref(false);
        const chartGenerated = ref(false);
        const isLoading = ref(false);
        const isVerifying = ref(false);
        const verifyStatus = ref(null);
        const userMessage = ref('');
        const chatHistory = ref([]);
        const chatRef = ref(null);
        const sessions = ref([]);
        const currentSessionId = ref(null);

        const settings = reactive({
            baseUrl: localStorage.getItem('dc_baseUrl') || 'https://api.openai.com',
            apiKey: localStorage.getItem('dc_apiKey') || '',
            model: localStorage.getItem('dc_model') || 'gpt-4o'
        });

        // Initialize user input with default full data
        const userInput = reactive({ name: '', gender: 'male', date: '', time: 12, province: 'åŒ—äº¬å¸‚', city: CHINA_AREA_DATA['åŒ—äº¬å¸‚'][0] });
        const chartData = reactive({ name: '', gender: '', baziString: '', trueSolarTime: '', wuxingDetail: '', ziweiSummary: '', sihua: '' });
        
        const currentPersonaId = ref('qingxu');
        const currentPersona = computed(() => PERSONAS.find(p => p.id === currentPersonaId.value));

        const availableCities = computed(() => CHINA_AREA_DATA[userInput.province] || []);
        const handleProvinceChange = () => { if (CHINA_AREA_DATA[userInput.province]) userInput.city = CHINA_AREA_DATA[userInput.province][0]; };

        onMounted(() => {
            const savedSessions = localStorage.getItem('dc_sessions');
            if (savedSessions) {
                try {
                    sessions.value = JSON.parse(savedSessions);
                    const lastSessionId = localStorage.getItem('dc_last_session_id');
                    if (lastSessionId) {
                        const session = sessions.value.find(s => s.id === lastSessionId);
                        if (session) loadSession(session.id);
                    }
                } catch(e) { console.error("History Load Error", e); }
            }
        });

        const saveSession = () => {
            if (!currentSessionId.value) return;
            const sessionData = {
                id: currentSessionId.value,
                timestamp: Date.now(),
                name: userInput.name || 'æœ‰ç¼˜äºº',
                summary: chatHistory.value.length > 1 ? chatHistory.value[1].content.slice(0, 50) + '...' : 'æ–°ä¼šè¯',
                userInput: { ...userInput },
                chartData: { ...chartData },
                chatHistory: chatHistory.value,
                personaId: currentPersonaId.value
            };
            const index = sessions.value.findIndex(s => s.id === currentSessionId.value);
            if (index !== -1) sessions.value[index] = sessionData;
            else sessions.value.unshift(sessionData);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            localStorage.setItem('dc_last_session_id', currentSessionId.value);
        };

        watch(chatHistory, () => { if (chartGenerated.value) saveSession(); }, { deep: true });

        const generateChart = () => {
            if (!userInput.date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            const [y, m, d] = userInput.date.split('-').map(Number);
            const h = parseInt(userInput.time);
            const baseSolar = new Date(y, m-1, d, h);
            const offsetMin = (userInput.city.lon - 120) * 4; 
            baseSolar.setMinutes(baseSolar.getMinutes() + offsetMin);
            const trueSolar = Solar.fromDate(baseSolar);
            const lunar = Lunar.fromSolar(trueSolar);
            const bazi = lunar.getEightChar();
            let ziweiStr = "æ˜Ÿç›˜éšæ™¦";
            let sihuaStr = "";
            try {
                if (window.iztro) {
                    const timeIdx = Math.floor((trueSolar.getHour()+1)/2) % 12;
                    const gender = userInput.gender === 'male' ? 'ç”·' : 'å¥³';
                    const astrolabe = window.iztro.astro.bySolar(`${y}-${m}-${d}`, timeIdx, gender, true);
                    const ming = astrolabe.palaces.find(p => p.name === 'å‘½å®«');
                    if(ming) ziweiStr = `${ming.majorStars.map(s=>s.name).join(' ')} åœ¨${ming.earthlyBranch}`;
                    const yearStem = bazi.getYearGan();
                    sihuaStr = `ç”Ÿå¹´å¹²[${yearStem}]`; 
                }
            } catch(e) { console.error(e); }

            chartData.name = userInput.name || 'æœ‰ç¼˜äºº';
            chartData.gender = userInput.gender === 'male' ? 'ç”·' : 'å¥³';
            chartData.trueSolarTime = trueSolar.toYmdHms();
            chartData.baziString = `${bazi.getYear()} ${bazi.getMonth()} ${bazi.getDay()} ${bazi.getTime()}`;
            chartData.wuxingDetail = `æ—¥ä¸»${bazi.getDayWuXing()} | ${bazi.getDayNaYin()}å‘½`;
            chartData.ziweiSummary = ziweiStr;
            chartData.sihua = sihuaStr;

            chartGenerated.value = true;
            currentSessionId.value = Date.now().toString();
            chatHistory.value = [];
            
            const welcomeMsg = currentPersona.value.id === 'all' 
                ? `ä¼—å¦™ä¹‹é—¨å·²å¼€ã€‚è¯·æ–½ä¸»å‡ºé¢˜ï¼Œæˆ‘ç­‰å››äººå°†ä¸ºä½ è”åˆæ¨æ¼”ã€‚`
                : `${currentPersona.value.name}å·²å°±ä½ã€‚è§‚ç¼˜ä¸»å‘½ç›˜ï¼Œ${chartData.baziString}ã€‚æœ‰ä½•å›°æƒ‘ï¼Ÿ`;

            chatHistory.value.push({
                role: 'assistant',
                content: welcomeMsg,
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc
            });
            saveSession();
        };

        const loadSession = (id) => {
            const session = sessions.value.find(s => s.id === id);
            if (!session) return;
            Object.assign(userInput, session.userInput);
            Object.assign(chartData, session.chartData);
            chatHistory.value = session.chatHistory;
            currentPersonaId.value = session.personaId || 'qingxu';
            currentSessionId.value = session.id;
            chartGenerated.value = true;
            showHistory.value = false;
            localStorage.setItem('dc_last_session_id', id);
            nextTick(scrollToBottom);
        };

        const deleteSession = (id) => {
            sessions.value = sessions.value.filter(s => s.id !== id);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            if (currentSessionId.value === id) {
                currentSessionId.value = null;
            }
        };

        const returnToHome = () => {
            chartGenerated.value = false;
            currentSessionId.value = null;
            localStorage.removeItem('dc_last_session_id');
        };

        const sortedSessions = computed(() => [...sessions.value].sort((a, b) => b.timestamp - a.timestamp));
        const formatDate = (ts) => new Date(ts).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });

        const switchPersona = (id) => {
            currentPersonaId.value = id;
            chatHistory.value.push({
                role: 'assistant',
                content: `${currentPersona.value.name}å·²æ¥æ‰‹ã€‚`,
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc
            });
            nextTick(scrollToBottom);
        };

        const handleSend = async () => {
            if (!userMessage.value.trim() || isLoading.value) return;
            if (!settings.apiKey) return alert("è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½® API Key");

            const text = userMessage.value;
            userMessage.value = '';
            chatHistory.value.push({ role: 'user', content: text });
            scrollToBottom();

            isLoading.value = true;
            const llm = new LLMService(settings);

            const contextData = {
                name: chartData.name,
                gender: chartData.gender,
                baziString: chartData.baziString,
                trueSolarTime: chartData.trueSolarTime,
                wuxingDetail: chartData.wuxingDetail,
                ziweiSummary: chartData.ziweiSummary,
                sihua: chartData.sihua
            };

            const systemPrompt = currentPersona.value.systemPrompt(contextData);
            const messages = [
                { role: 'system', content: systemPrompt },
                ...chatHistory.value.filter(m => m.role !== 'system').slice(-10).map(m => ({ role: m.role, content: m.content }))
            ];

            const aiMsg = reactive({
                role: 'assistant',
                content: '',
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc,
                isTyping: true
            });
            chatHistory.value.push(aiMsg);

            await llm.chatStream(
                messages,
                (chunk) => {
                    aiMsg.content += chunk;
                    scrollToBottom();
                },
                (err) => {
                    aiMsg.content += `\n[é”™è¯¯: ${err}]`;
                    aiMsg.isTyping = false;
                },
                () => {
                    aiMsg.isTyping = false;
                    isLoading.value = false;
                    saveSession();
                }
            );
        };

        const runTest = async () => {
            if(!settings.apiKey) return verifyStatus.value = { ok: false, msg: 'è¯·è¾“å…¥ API Key' };
            isVerifying.value = true;
            verifyStatus.value = null;
            const llm = new LLMService(settings);
            verifyStatus.value = await llm.testConnection();
            isVerifying.value = false;
        };

        const saveSettings = () => {
            localStorage.setItem('dc_baseUrl', settings.baseUrl);
            localStorage.setItem('dc_apiKey', settings.apiKey);
            localStorage.setItem('dc_model', settings.model);
            showSettings.value = false;
        };

        const scrollToBottom = () => { if(chatRef.value) chatRef.value.scrollTop = chatRef.value.scrollHeight; };
        const renderMarkdown = (t) => md.render(t);

        return {
            chinaAreaData: CHINA_AREA_DATA, availableCities, handleProvinceChange,
            shichenOptions: SHICHEN_OPTIONS, personas: PERSONAS,
            settings, userInput, chartData,
            showSettings, showHistory, chartGenerated, isLoading, isVerifying, verifyStatus,
            userMessage, chatHistory, chatRef, sessions, sortedSessions,
            currentPersonaId, currentPersona,
            generateChart, switchPersona, handleSend, runTest, saveSettings, renderMarkdown,
            loadSession, deleteSession, formatDate, returnToHome
        };
    }
}).mount('#app');
</script>
</body>
</html>


